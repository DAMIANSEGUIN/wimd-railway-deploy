repos:
  # Python code quality - Ruff (replaces flake8, isort, pyupgrade)
  - repo: https://github.com/astral-sh/ruff-pre-commit
    rev: v0.6.8
    hooks:
      - id: ruff
        args: [--fix, --exit-non-zero-on-fix]
        name: Ruff linter (PEP 8 + security checks)
      - id: ruff-format
        name: Ruff formatter (Black-compatible)

  # Python code formatting - Black
  - repo: https://github.com/psf/black
    rev: 24.10.0
    hooks:
      - id: black
        name: Black code formatter
        language_version: python3.9

  # Security - Git secrets detection
  - repo: https://github.com/gitleaks/gitleaks
    rev: v8.18.4
    hooks:
      - id: gitleaks
        name: Gitleaks (detect hardcoded secrets)

  # Security - Additional secret detection
  - repo: https://github.com/Yelp/detect-secrets
    rev: v1.5.0
    hooks:
      - id: detect-secrets
        name: Detect secrets in code
        args: ['--baseline', '.secrets.baseline']
        exclude: package-lock.json

  # Python security - Bandit (security linter)
  - repo: https://github.com/PyCQA/bandit
    rev: 1.7.10
    hooks:
      - id: bandit
        name: Bandit security linter
        args: ['-c', 'pyproject.toml']
        additional_dependencies: ['bandit[toml]']

  # Python type checking - mypy
  - repo: https://github.com/pre-commit/mirrors-mypy
    rev: v1.11.2
    hooks:
      - id: mypy
        name: mypy (type checking)
        args: [--ignore-missing-imports, --strict, --exclude, '.claude-run/']
        additional_dependencies: []
        exclude: ^(tests/|\.claude-run/)

  # Custom local hooks
  - repo: local
    hooks:
      # Mosaic-specific: PostgreSQL pattern enforcement
      - id: check-postgres-patterns
        name: Check PostgreSQL context manager pattern
        entry: python3 -c "import sys; code = open(sys.argv[1]).read(); sys.exit(1 if 'conn = get_conn()' in code and 'with get_conn()' not in code else 0)"
        language: system
        files: '^api/.*\.py$'
        exclude: ^api/storage.py$

      # Mosaic-specific: No SQLite syntax in PostgreSQL code
      - id: check-no-sqlite-syntax
        name: Check no SQLite syntax (use %s not ?)
        entry: python3 -c "import sys, re; code = open(sys.argv[1]).read(); sys.exit(1 if re.search(r'execute\([^)]*\?', code) else 0)"
        language: system
        files: '^api/.*\.py$'

# Configuration
default_language_version:
  python: python3.9

# Global excludes
exclude: |
  (?x)^(
      \.git/|
      \.venv/|
      venv/|
      __pycache__/|
      \.pytest_cache/|
      node_modules/|
      build/|
      dist/|
      .*\.egg-info/|
      backups/|
      docs_archive/|
      Archives/|
      \.claude-run/
  )$

# Fail fast: stop on first failure
fail_fast: false

# Minimum pre-commit version
minimum_pre_commit_version: '2.21.0'