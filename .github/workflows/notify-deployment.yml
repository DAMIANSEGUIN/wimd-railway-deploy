name: Deployment Notification

on:
  push:
    branches:
      - main

jobs:
  notify:
    name: Notify Deployment Status
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get commit info
        id: commit
        run: |
          echo "sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "message=$(git log -1 --pretty=%B | head -1)" >> $GITHUB_OUTPUT
          echo "author=$(git log -1 --pretty=%an)" >> $GITHUB_OUTPUT

      - name: Wait for Render deployment
        run: |
          echo "â³ Waiting 90 seconds for Render to deploy (free tier cold start)..."
          sleep 90

      - name: Check Render deployment
        id: health
        run: |
          HEALTH_URL="https://mosaic-backend-tpog.onrender.com/health"

          echo "ðŸ” Checking Render health endpoint (with retries)..."

          MAX_RETRIES=3
          RETRY_DELAY=15
          SUCCESS=false

          for i in $(seq 1 $MAX_RETRIES); do
            echo "Attempt $i/$MAX_RETRIES..."
            RESPONSE=$(curl -s --max-time 10 "$HEALTH_URL" 2>/dev/null || echo '{"ok":false}')

            if echo "$RESPONSE" | grep -q '"ok":true'; then
              echo "status=success" >> $GITHUB_OUTPUT
              echo "âœ… Render deployment successful"
              echo "response=$RESPONSE" >> $GITHUB_OUTPUT
              SUCCESS=true
              break
            else
              if [ $i -lt $MAX_RETRIES ]; then
                echo "â³ Service not ready yet, waiting ${RETRY_DELAY}s..."
                sleep $RETRY_DELAY
              fi
            fi
          done

          if [ "$SUCCESS" = false ]; then
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "response=$RESPONSE" >> $GITHUB_OUTPUT
            echo "âŒ Render deployment failed or service unhealthy after $MAX_RETRIES attempts"
          fi

      - name: Create deployment summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          # ðŸš€ Render Deployment

          **Commit:** ${{ steps.commit.outputs.sha }}
          **Message:** ${{ steps.commit.outputs.message }}
          **Author:** ${{ steps.commit.outputs.author }}
          **Branch:** main

          ## Deployment Status

          ${{ steps.health.outputs.status == 'success' && 'âœ… **Deployment Successful**' || 'âŒ **Deployment Failed**' }}

          **Backend Health:** https://mosaic-backend-tpog.onrender.com/health
          **Frontend:** https://whatismydelta.com

          ### Health Response
          ```json
          ${{ steps.health.outputs.response }}
          ```

          ---

          *Triggered by push to main*
          EOF

      - name: Deployment result
        if: steps.health.outputs.status == 'failed'
        run: |
          echo "âŒ Render deployment appears to have failed"
          echo "Check Render dashboard: https://dashboard.render.com"
          exit 1
