name: Comprehensive Testing (Backend + Frontend)

# THE WATCHER: Automatically runs ALL tests on every commit
# Created: 2026-02-06
# Purpose: Ensure no code reaches production without passing full test suite

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  # Allow manual trigger
  workflow_dispatch:

jobs:
  comprehensive-test:
    name: Run All Tests (Backend + Frontend)
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      # ===================================================================
      # SETUP
      # ===================================================================

      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v3

      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      # ===================================================================
      # BACKEND SETUP
      # ===================================================================

      - name: ğŸ”§ Install Backend Dependencies
        run: |
          pip install pytest
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi

      # ===================================================================
      # FRONTEND SETUP
      # ===================================================================

      - name: ğŸ­ Install Playwright
        run: |
          npm install -D @playwright/test
          npx playwright install --with-deps chromium

      - name: ğŸ“‹ Verify Test Files Present
        run: |
          echo "Backend tests:"
          ls -la tests/*.py | wc -l
          echo "Frontend tests:"
          ls -la test-ps101-*.js | wc -l

      # ===================================================================
      # RUN MASTER TEST SUITE
      # ===================================================================

      - name: ğŸ§ª Run Comprehensive Test Suite
        id: test-suite
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Running master test suite with full logging..."
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          ./scripts/test_all.sh
        continue-on-error: false  # Fail the workflow if tests fail

      # ===================================================================
      # UPLOAD ARTIFACTS (On Success or Failure)
      # ===================================================================

      - name: ğŸ“Š Upload Test Logs
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: test-logs
          path: /tmp/test_all_*.log
          retention-days: 30

      - name: ğŸ“¸ Upload Playwright Screenshots (On Failure)
        if: failure()
        uses: actions/upload-artifact@v3
        with:
          name: playwright-screenshots
          path: test-results/
          retention-days: 30

      - name: ğŸ“¹ Upload Playwright Videos (On Failure)
        if: failure()
        uses: actions/upload-artifact@v3
        with:
          name: playwright-videos
          path: test-results/
          retention-days: 30

      # ===================================================================
      # RESULTS SUMMARY
      # ===================================================================

      - name: ğŸ“‹ Test Results Summary
        if: always()
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Test Results Summary"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          if [ -f /tmp/test_all_*.log ]; then
            tail -n 50 /tmp/test_all_*.log
          fi

      - name: âœ… All Tests Passed
        if: success()
        run: |
          echo "âœ… âœ… âœ… âœ… âœ… âœ… âœ… âœ… âœ… âœ… âœ… âœ… âœ… âœ… âœ… âœ… âœ…"
          echo "ALL TESTS PASSED - SAFE TO DEPLOY"
          echo "âœ… âœ… âœ… âœ… âœ… âœ… âœ… âœ… âœ… âœ… âœ… âœ… âœ… âœ… âœ… âœ… âœ…"

      - name: âŒ Tests Failed
        if: failure()
        run: |
          echo "âŒ âŒ âŒ âŒ âŒ âŒ âŒ âŒ âŒ âŒ âŒ âŒ âŒ âŒ âŒ âŒ âŒ"
          echo "TESTS FAILED - DO NOT DEPLOY"
          echo "Check artifacts above for detailed logs and screenshots"
          echo "âŒ âŒ âŒ âŒ âŒ âŒ âŒ âŒ âŒ âŒ âŒ âŒ âŒ âŒ âŒ âŒ âŒ"
          exit 1

  # ===================================================================
  # OPTIONAL: Frontend-Only Quick Check (Fast Feedback)
  # ===================================================================

  frontend-smoke:
    name: Frontend Smoke Test (Quick Check)
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v3

      - name: ğŸ”¥ Run Frontend Smoke Test
        run: |
          ./scripts/test_frontend_smoke.sh https://whatismydelta.com

      - name: âœ… Frontend Smoke Test Passed
        if: success()
        run: echo "âœ… Frontend smoke test passed - critical features present"

  # ===================================================================
  # STATUS CHECK: REQUIRED FOR MERGE
  # ===================================================================
  # GitHub branch protection can require this workflow to pass before merge

  all-tests-passed:
    name: All Tests Passed (Required Check)
    runs-on: ubuntu-latest
    needs: [comprehensive-test, frontend-smoke]
    if: always()

    steps:
      - name: Check Test Results
        run: |
          if [ "${{ needs.comprehensive-test.result }}" != "success" ]; then
            echo "âŒ Comprehensive tests failed"
            exit 1
          fi
          if [ "${{ needs.frontend-smoke.result }}" != "success" ]; then
            echo "âŒ Frontend smoke test failed"
            exit 1
          fi
          echo "âœ… All tests passed - safe to merge"
