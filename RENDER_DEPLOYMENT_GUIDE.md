# Render Deployment Guide (GitHub-Based)

**Version:** 1.0
**Created:** 2026-01-07
**Migration Date:** 2026-01-05 23:40 UTC
**Status:** ACTIVE

---

## DEPLOYMENT STATUS

**Current Platform:** Render
**Migration:** Render → Render (completed 2026-01-05)
**Deployment Method:** GitHub-based (auto-deploy on push to main)

**Production URLs:**
- Backend: https://mosaic-backend-tpog.onrender.com
- Frontend: https://whatismydelta.com (Netlify)

**Service Details:**
- Service ID: `srv-d5e4j0qli9vc73esori0`
- Database ID: `dpg-d5e4ilali9vc73esoj2g-a`
- Region: Oregon
- Runtime: Python

---

## WHY RENDER?

**Migration Reasons:**
1. Render health check failures (continuous issues despite extended timeouts)
2. Nixpacks deprecated (build system no longer maintained)
3. PostgreSQL connection race conditions
4. Better alternative: Render offers native Python support and proven reliability

**Benefits:**
- ✅ Native Python runtime (no nixpacks complexity)
- ✅ Stable platform with better documentation
- ✅ PostgreSQL 18 (latest version)
- ✅ Predictable pricing ($7/month web + $7/month DB after free tier)
- ✅ Auto-deploy on git push
- ✅ Zero downtime deployments

---

## CURRENT CONFIGURATION

**Backend Service (mosaic-backend):**
```yaml
Service Type: Web Service
Plan: Starter ($7/month)
Region: Oregon
Build Command: pip install -r requirements.txt
Start Command: gunicorn api.index:app --workers 2 --worker-class uvicorn.workers.UvicornWorker --bind 0.0.0.0:$PORT --timeout 120
Health Check Path: /health
Auto Deploy: Yes (main branch)
```

**Database (mosaic-db):**
```yaml
Database Type: PostgreSQL
Version: 18
Plan: Free (expires 2026-02-04, then $7/month)
Database Name: mosaic_0tma
User: mosaic_user
Region: Oregon
```

**Environment Variables:**
```bash
OPENAI_API_KEY=sk-***  # From Render
CLAUDE_API_KEY=sk-ant-***  # From Render
PUBLIC_SITE_ORIGIN=https://whatismydelta.com
APP_SCHEMA_VERSION=v2
DATABASE_URL=***  # Auto-generated by Render
```

---

## DEPLOYMENT WORKFLOW

### Normal Deploy (Main Branch)

```bash
# 1. Ensure you're on main
git checkout main

# 2. Merge feature branch (if applicable)
git merge your-feature-branch

# 3. Push to GitHub
git push origin main

# 4. Render auto-deploys (2-5 minutes)
# Watch: https://dashboard.render.com/web/srv-d5e4j0qli9vc73esori0
```

### Feature Branch Testing

Render doesn't auto-deploy feature branches by default. Options:

**Option A: Merge to main (recommended)**
```bash
git checkout main
git merge feature-branch
git push origin main
```

**Option B: Create preview environment**
```
1. Render Dashboard → Services → mosaic-backend
2. Click "Preview Environments"
3. Enable for pull requests
```

---

## POST-DEPLOYMENT VERIFICATION

### Check 1: Service Health
```bash
curl https://mosaic-backend-tpog.onrender.com/health
# Expected: {"ok":true,"timestamp":"2026-01-07T..."}
```

### Check 2: Config Endpoint
```bash
curl https://mosaic-backend-tpog.onrender.com/config
# Expected: {"apiBase":"","schemaVersion":"v2"}
```

### Check 3: Database Connection
```bash
# Check logs in Render dashboard
# Look for: "[STORAGE] ✅ PostgreSQL connection pool created"
# Should NOT see: "SQLite fallback"
```

### Check 4: Frontend Integration
```bash
# Visit frontend
open https://whatismydelta.com

# Verify API calls go to Render backend
# Check browser console network tab
```

---

## TROUBLESHOOTING

### Issue: Deploy stuck at "Building..."
**Cause:** Large dependency install
**Fix:** Wait (first deploy takes 2-5 minutes)
**Check:** Render Dashboard → Deployments → Build Logs

### Issue: Deploy fails with "ModuleNotFoundError"
**Cause:** Missing dependency in requirements.txt
**Fix:** Add dependency, commit, push again
**Check:** Ensure requirements.txt includes all imports

### Issue: "503 Service Unavailable"
**Cause:** App crashed on startup
**Fix:** Check Render → Deployments → Deploy Logs
**Common causes:**
- Missing environment variable
- Database connection failed
- Import error
- Port binding issue (must use `$PORT` env var)

### Issue: Old code still running
**Cause:** Render cached old deployment
**Fix:** Render Dashboard → Manual Deploy → Clear build cache & deploy

### Issue: Database connection timeout
**Cause:** Using external (public) DATABASE_URL instead of internal
**Fix:** Ensure DATABASE_URL uses internal connection string
**Check:** Render Dashboard → Database → Internal Connection String

---

## PRE-DEPLOYMENT CHECKLIST

**Before Pushing:**
- [ ] All tests pass locally
- [ ] No console.log / print debugging left in code
- [ ] Environment variables documented in .env.example
- [ ] No secrets committed to git
- [ ] Commit message follows convention
- [ ] Feature branch merged to main
- [ ] Run `./scripts/verify_critical_features.sh`

**After Render Deploy:**
- [ ] Health endpoint returns {"ok":true}
- [ ] Config shows schemaVersion:"v2"
- [ ] Database connection active (PostgreSQL, not SQLite)
- [ ] Frontend can reach backend API
- [ ] No errors in Render logs
- [ ] Check deployment time (should be < 5 minutes)

---

## ROLLBACK PROCEDURE

If deployment breaks production:

### Option 1: Revert via Git
```bash
# Find last good commit
git log --oneline -5

# Revert the bad commit
git revert HEAD  # Or: git revert abc1234

# Push revert
git push origin main

# Render auto-deploys the revert
```

### Option 2: Redeploy Previous via Render Dashboard
```
1. Render → Services → mosaic-backend
2. Click "Deployments" tab
3. Find last working deployment
4. Click "Redeploy"
```

---

## MONITORING

### Production Health Check
```bash
# Automated check (add to cron or monitoring service)
curl -f https://mosaic-backend-tpog.onrender.com/health || echo "ALERT: Service down"
```

### Render Logs
```
# Via Dashboard
1. Render → Services → mosaic-backend
2. Click "Logs" tab
3. Filter by time range or search

# Real-time logs
Render → Services → mosaic-backend → Logs (auto-updates)
```

### Database Metrics
```
# Via Dashboard
Render → Databases → mosaic-db → Metrics
- Connection count
- Disk usage
- Query performance
```

---

## COST MANAGEMENT

### Render Pricing (as of 2026-01-07)

**Web Service (mosaic-backend):**
- Plan: Starter
- Cost: $7/month
- Includes: 512MB RAM, automatic scaling

**Database (mosaic-db):**
- Plan: Free (30-day trial)
- Expires: 2026-02-04
- After expiry: $7/month for PostgreSQL Starter
- **ACTION REQUIRED:** Upgrade before 2026-02-04 or data will be lost

**Total Monthly Cost:**
- Current: $7/month (web only)
- After DB upgrade: $14/month

**Cost Optimization:**
- GitHub-based deployment (no CLI overhead)
- Monitor usage in Render dashboard
- Set up billing alerts
- Consider paid plan only if free tier insufficient

---

## ENVIRONMENT-SPECIFIC URLS

### Production
- **Backend:** https://mosaic-backend-tpog.onrender.com
- **Frontend:** https://whatismydelta.com (Netlify)
- **Backend Dashboard:** https://dashboard.render.com/web/srv-d5e4j0qli9vc73esori0
- **Database Dashboard:** https://dashboard.render.com/d/dpg-d5e4ilali9vc73esoj2g-a

### Development
- **Local Backend:** http://localhost:8000 (FastAPI)
- **Local Frontend:** Open `mosaic_ui/index.html` in browser

---

## RENDER DASHBOARD ACCESS

### Service Management
```
1. Login: https://dashboard.render.com
2. Select service: mosaic-backend
3. Available tabs:
   - Events: Deployment history
   - Logs: Real-time/historical logs
   - Metrics: CPU, memory, requests
   - Settings: Environment vars, build config
   - Shell: Access running container
```

### Database Management
```
1. Render Dashboard → Databases → mosaic-db
2. Tabs:
   - Info: Connection strings, credentials
   - Metrics: Performance stats
   - Backups: (Not available on free tier)
   - Settings: Plan, region, version
```

---

## CRITICAL NOTES

### ⚠️ Database Free Tier Expiration
**Date:** 2026-02-04 (28 days from creation)
**Action Required:** Upgrade to paid plan before expiration
**Cost:** $7/month for PostgreSQL Starter
**Risk:** Data loss if not upgraded
**Reminder:** Set calendar reminder for 2026-02-01

### Environment Variables Security
- Never commit .env files
- Rotate API keys if exposed
- Use Render secret files for sensitive config
- All secrets masked in logs

### Deployment Best Practices
- Always test locally before pushing
- Use feature branches for non-trivial changes
- Monitor first 5 minutes after deploy
- Keep deployment size < 500MB
- Use `.dockerignore` to exclude unnecessary files

---

## MIGRATION NOTES (Historical)

**Migration Date:** 2026-01-05 23:40 UTC
**Previous Platform:** Render
**Migration Reason:** Health check failures, deprecated build system
**Migration Duration:** ~10 minutes
**Downtime:** 0 minutes (Render remained operational during migration)

**What Changed:**
- Backend URL: Render → Render
- Database: Render PostgreSQL → Render PostgreSQL 18
- Build system: Nixpacks → Native Python runtime
- Configuration: render.toml → render.yaml

**What Stayed the Same:**
- Frontend: Netlify (no changes)
- Repository: Same GitHub repo
- Code: No application code changes
- Environment variables: Same keys, different platform

---

## RELATED DOCUMENTATION

- **Main Dev Reference:** `CLAUDE.md`
- **Migration Report:** `.mosaic/RENDER_MIGRATION_COMPLETE.md`
- **Troubleshooting:** `TROUBLESHOOTING_CHECKLIST.md`
- **Cross-Agent Protocol:** `.ai-agents/CROSS_AGENT_PROTOCOL.md`
- **Verification Script:** `scripts/verify_critical_features.sh`

---

## QUICK COMMANDS REFERENCE

```bash
# Deploy to production
git push origin main

# Check service health
curl https://mosaic-backend-tpog.onrender.com/health

# Verify critical features before deploy
./scripts/verify_critical_features.sh

# View recent commits
git log --oneline -5

# Rollback deployment
git revert HEAD && git push origin main
```

---

**END OF RENDER DEPLOYMENT GUIDE**

**Status:** Production deployment active
**Platform:** Render
**Last Updated:** 2026-01-07
**Next Action:** Upgrade database plan before 2026-02-04
