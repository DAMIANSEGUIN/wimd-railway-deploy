<!doctype html>
<meta charset="utf-8">
<title>What Is My Delta ‚Äî Find Your Next Career Move</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  :root{--fg:#000;--muted:#666;--line:#e8e8e8;--hair:#111;--max:980px;--api:'https://mosaic-backend-tpog.onrender.com'}
  *{box-sizing:border-box}
  html,body{margin:0;background:#fff;color:var(--fg)}
  body{font:12px/1.75 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  a{color:inherit;text-decoration:none}
  a:hover,a:focus{text-decoration:underline}
  .wrap{max-width:var(--max);margin:0 auto;padding:28px 20px}

  .nav{display:flex;gap:24px;margin-bottom:60px;flex-wrap:wrap;align-items:center}
  .hero{margin:120px 0 40px}
  .title{font:500 15px/1.4 Helvetica,Arial;letter-spacing:.02em}
  .sub{color:var(--muted);max-width:64ch}
  .actions{margin:24px 0 0;display:flex;gap:16px;align-items:center;flex-wrap:wrap}
  .quiet{border:1px solid var(--line);padding:6px 10px;background:#fff;cursor:pointer;font:inherit;transition:background 0.2s ease}
  .quiet:hover{background:#f8f8f8}
  .quiet:focus{outline:2px solid #0ea5e9;outline-offset:2px}

  svg.schema{display:block;width:100%;height:auto;margin:50px 0}
  .wire{stroke:var(--hair);stroke-width:.7;fill:none;stroke-linecap:round;stroke-linejoin:round}
  .dot{fill:var(--hair)}

  .rule{border-top:1px solid var(--line);margin:80px 0}
  .metrics{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:16px;margin:30px 0 90px}
  .card{border:1px solid var(--line);padding:14px;transition:box-shadow 0.2s ease}
  .card:hover{box-shadow:0 2px 8px rgba(0,0,0,0.1)}
  .k{color:var(--muted);text-transform:uppercase;letter-spacing:.08em;font-size:10px}
  .v{font-size:18px;font-weight:600;margin-top:4px}

  .island{margin:100px 0}
  .module{margin:70px 0;transition:transform 0.2s ease}
  .module:hover{transform:translateY(-1px)}
  .module h3{margin:0 0 6px;font:600 12px/1 Helvetica,Arial;text-transform:uppercase;letter-spacing:.06em}
  .module ul{list-style:none;margin:6px 0 0;padding:0;color:var(--muted)}
  .module li{margin:3px 0}
  textarea.small{width:100%;min-height:60px;border:1px solid var(--line);padding:8px;background:#fff;font:inherit;transition:border-color 0.2s ease}
  textarea.small:focus{border-color:#0ea5e9;outline:none}
  .module-actions{margin-top:8px;display:flex;gap:12px;flex-wrap:wrap}
  .module-actions a{color:var(--muted);font-size:11px;transition:color 0.2s ease}
  .module-actions a:hover{color:var(--fg)}

  .welcome-title{font:600 12px/1 Helvetica,Arial;text-transform:uppercase;letter-spacing:.08em}
  details.micro{margin-top:16px}
  details.micro summary{cursor:pointer;user-select:none}
  details.micro summary:hover{color:var(--muted)}

  .chat{position:fixed;right:20px;bottom:20px;width:320px;max-width:90vw;background:#fff;border:1px solid var(--line);box-shadow:0 8px 30px rgba(0,0,0,.06);display:none;z-index:1000;border-radius:8px;overflow:hidden}
  .chat header{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;border-bottom:1px solid var(--line);background:#f8f8f8}
  .chat header .x{border:1px solid var(--line);padding:2px 6px;background:#fff;cursor:pointer;border-radius:2px;transition:background 0.2s ease}
  .chat header .x:hover{background:#f0f0f0}
  .chat main{padding:10px 12px;height:220px;overflow:auto;scroll-behavior:smooth}
  .msg{margin:6px 0;font:11px/1.4 Helvetica,Arial;word-wrap:break-word}
  .msg.you{color:var(--hair)}
  .msg.bot{color:var(--muted)}
  .msg.loading{color:var(--muted);opacity:0.6;animation:pulse 1.5s ease-in-out infinite}
.chat footer{padding:8px 10px;border-top:1px solid var(--line);display:flex;gap:6px}
.chat input{flex:1;border:1px solid var(--line);padding:6px 8px;font:inherit;border-radius:2px}
.chat input:focus{border-color:#0ea5e9;outline:none}
.chat button{border:1px solid var(--line);padding:6px 8px;background:#fff;cursor:pointer;border-radius:2px;transition:background 0.2s ease}
.chat button:hover{background:#f8f8f8}
.auth-floating{position:fixed;bottom:28px;right:28px;padding:12px 16px;background:var(--hair);color:#fff;border:none;border-radius:24px;font-size:12px;letter-spacing:.08em;text-transform:uppercase;box-shadow:0 12px 28px rgba(6,33,88,0.25);cursor:pointer;display:none;z-index:1500;transition:transform 0.2s ease, box-shadow 0.2s ease}
.auth-floating:hover{transform:translateY(-2px);box-shadow:0 16px 32px rgba(6,33,88,0.3)}
@media(max-width:680px){
  .auth-floating{bottom:18px;right:18px;font-size:11px;padding:10px 14px}
}

  .modal{position:fixed;inset:0;background:rgba(255,255,255,.95);display:none;align-items:center;justify-content:center;z-index:2000;backdrop-filter:blur(4px)}
  .modal .panel{background:#fff;border:1px solid var(--line);padding:20px;min-width:280px;max-width:92vw;border-radius:8px;box-shadow:0 10px 40px rgba(0,0,0,0.1)}
  .modal .close{margin-top:16px;border:1px solid var(--line);background:#fff;padding:6px 10px;cursor:pointer;border-radius:2px;transition:background 0.2s ease}
  .modal .close:hover{background:#f8f8f8}
  .drop{border:1px dashed #ccc;padding:24px;text-align:center;cursor:pointer;border-radius:4px;transition:all 0.2s ease}
  .drop:hover{background:#fafafa;border-color:#999}

  .coach-strip{margin:24px 0 60px;border:1px solid var(--line);padding:6px 8px;display:flex;gap:8px;align-items:center;border-radius:4px;background:#fafafa}
  .coach-strip input{flex:1;border:1px solid var(--line);padding:6px 8px;font:inherit;border-radius:2px;background:#fff}
  .coach-strip input:focus{border-color:#0ea5e9;outline:none}
  .coach-strip span{color:var(--muted);font:11px/1 Helvetica,Arial;white-space:nowrap}

  .savebar{margin:80px 0 0;display:flex;gap:18px;flex-wrap:wrap}
  .btn{border:1px solid var(--line);padding:6px 10px;background:#fff;cursor:pointer;font:inherit;border-radius:2px;transition:all 0.2s ease}
  .btn:hover{background:#f8f8f8;transform:translateY(-1px)}
  .btn:focus{outline:2px solid #0ea5e9;outline-offset:2px}

  .formrow{margin:16px 0}
  .radio{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .radio label{display:flex;gap:6px;align-items:center;cursor:pointer;transition:color 0.2s ease}
  .radio label:hover{color:var(--muted)}
  .notice{position:fixed;left:20px;right:20px;bottom:16px;display:none;justify-content:space-between;gap:12px;background:#fff;border:1px solid var(--line);padding:8px 10px;z-index:1500;border-radius:4px;box-shadow:0 4px 12px rgba(0,0,0,0.1)}
  .notice .btn{border:1px solid var(--line);background:#fff;padding:6px 10px;border-radius:2px}

  .foot{border-top:1px solid var(--line);margin-top:140px;padding:14px 0;color:#777;font-size:12px;display:flex;justify-content:space-between;flex-wrap:wrap;gap:12px}

  .status{display:inline-block;padding:2px 6px;font-size:10px;border-radius:12px;font-weight:500}
  .status.working{background:#e8f5e8;color:#2d6e2d}
  .status.error{background:#ffe8e8;color:#d63638}

  @keyframes pulse {
    0%, 100% { opacity: 0.6; }
    50% { opacity: 1; }
  }

  @media (max-width:860px){
    .metrics{grid-template-columns:1fr}
    .actions{flex-direction:column;align-items:flex-start}
    .radio{flex-direction:column;align-items:flex-start}
    .nav{gap:16px}
    .foot{flex-direction:column;text-align:center}
    .chat{width:280px;right:10px;bottom:10px}
  }

  @media (max-width:480px){
    .wrap{padding:20px 16px}
    .hero{margin:80px 0 30px}
    .coach-strip{flex-direction:column;gap:10px;align-items:stretch}
    .coach-strip input{width:100%}
    .actions .quiet{width:100%;text-align:center}
  }

  .tooltip{position:relative;cursor:help;color:var(--muted);border:1px solid var(--line);border-radius:50%;width:14px;height:14px;display:inline-flex;align-items:center;justify-content:center;font-size:9px;margin-left:4px}
  .tooltip:hover::after{content:attr(data-tip);position:absolute;bottom:100%;left:50%;transform:translateX(-50%);background:var(--fg);color:#fff;padding:8px 10px;border-radius:4px;font-size:11px;white-space:normal;max-width:200px;z-index:1000;box-shadow:0 2px 8px rgba(0,0,0,0.2)}
  .intro-process{margin:40px 0 60px;padding:20px;border:1px solid var(--line);border-radius:4px;background:#fafafa}
  .intro-process h2{margin:0 0 16px;font:600 14px/1.2 Helvetica,Arial}
  .process-steps{display:flex;gap:20px;margin:20px 0;flex-wrap:wrap}
  .step{flex:1;min-width:200px;padding:16px;border:1px solid var(--line);border-radius:4px;background:#fff}
  .step strong{display:block;margin-bottom:4px;color:var(--fg)}
  .step span{color:var(--muted);font-size:11px;line-height:1.4}
  .resource-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:30px;margin:20px 0}
  .resource-grid h4{margin:0 0 10px;font-size:12px;text-transform:uppercase;letter-spacing:0.05em}
  .resource-grid ul{list-style:none;padding:0;margin:0}
  .resource-grid li{margin:6px 0}
  .resource-grid a{color:var(--muted);font-size:11px;transition:color 0.2s ease}
  .resource-grid a:hover{color:var(--fg)}
  .help-section{margin:40px 0;padding:20px;border:1px solid var(--line);border-radius:4px}
  .help-section h3{margin:0 0 16px;font-size:14px}
  .process-flow{display:flex;align-items:center;gap:20px;margin:20px 0;flex-wrap:wrap}
  .flow-step{flex:1;min-width:200px;text-align:center}
  .step-number{width:40px;height:40px;border-radius:50%;background:var(--fg);color:#fff;display:flex;align-items:center;justify-content:center;margin:0 auto 12px;font-weight:600}
  .step-content strong{display:block;margin-bottom:8px}
  .step-content p{margin:8px 0;color:var(--muted);font-size:12px}
  .step-content small{color:var(--muted);font-size:10px}
  .flow-arrow{font-size:24px;color:var(--muted)}
  .example-qa{margin:20px 0;padding:16px;border:1px solid var(--line);border-radius:4px}
  .question{font-weight:600;margin-bottom:8px;color:var(--fg)}
  .example-answer{color:var(--muted);font-style:italic;font-size:12px;line-height:1.5}
  .methodology-steps{margin:20px 0}
  .method-step{margin:20px 0;padding:16px;border-left:3px solid var(--line);padding-left:20px}
  .method-step strong{display:block;margin-bottom:8px;color:var(--fg)}
  .method-step p{margin:0;color:var(--muted);font-size:12px;line-height:1.5}

  /* PS101 Styles */
  .ps101-welcome{max-width:640px;margin:80px auto;padding:40px 20px;text-align:center}
  .ps101-welcome.hidden{display:none}
  .ps101-container.hidden{display:none}
  .ps101-completion.hidden{display:none}
  .previous-answers.hidden{display:none}
  .welcome-resume.hidden{display:none}
  .welcome-title{font-size:28px;font-weight:600;margin:0 0 8px;color:var(--fg)}
  .welcome-subtitle{font-size:14px;font-weight:400;color:var(--muted);margin:0 0 32px;letter-spacing:.05em;text-transform:uppercase}
  .welcome-description{margin-bottom:32px;text-align:left}
  .welcome-description p{font-size:14px;line-height:1.6;color:var(--fg);margin-bottom:16px}
  .welcome-features{list-style:none;padding:0;margin:0}
  .welcome-features li{font-size:13px;line-height:2;color:var(--muted)}
  .welcome-actions{display:flex;flex-direction:column;gap:12px;margin-bottom:24px}
  .welcome-btn-primary{font-weight:500;background:linear-gradient(145deg,#fff 0%,#f8f8f8 100%);border-color:var(--hair)}
  .welcome-btn-secondary{background:transparent;border-color:var(--line)}
  .welcome-resume{margin-top:32px;padding-top:24px;border-top:1px solid var(--line)}
  .resume-text{font-size:12px;color:var(--muted);margin-bottom:12px}

  .ps101-container{max-width:var(--max);margin:0 auto;padding:40px 20px}
  .ps101-progress{max-width:var(--max);margin:0 auto 40px;padding:20px}
  .progress-header{text-align:center;margin-bottom:16px}
  .step-label{font-size:14px;font-weight:500;color:var(--fg);letter-spacing:.02em}
  .progress-dots{display:flex;justify-content:center;gap:12px;align-items:center;flex-wrap:wrap}
  .progress-dots .dot{width:32px;height:32px;border-radius:50%;border:1px solid var(--line);background:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;color:var(--muted);cursor:pointer;transition:all 0.2s ease}
  .progress-dots .dot:hover{border-color:var(--hair);transform:translateY(-1px)}
  .progress-dots .dot.completed{background:linear-gradient(145deg,#f5f5f5 0%,#eee 100%);color:var(--fg);border-color:var(--hair)}
  .progress-dots .dot.active{background:linear-gradient(145deg,#fff 0%,#f8f8f8 100%);box-shadow:0 3px 8px rgba(0,0,0,0.12);color:var(--fg);font-weight:600;border-color:var(--hair)}
  .progress-dots .dot:disabled{cursor:not-allowed;opacity:0.5}

  /* Experiment Components Styles */
  .experiment-components{margin:32px 0;padding:24px;border:1px solid var(--line);border-radius:6px;background:linear-gradient(145deg,#fff 0%,#fafafa 100%)}
  .experiment-components.hidden{display:none}
  .component-title{font-size:16px;font-weight:600;margin-bottom:20px;color:var(--fg)}
  .experiment-form{display:flex;flex-direction:column;gap:16px}
  .form-group{display:flex;flex-direction:column;gap:6px}
  .form-group label{font-size:12px;font-weight:500;text-transform:uppercase;letter-spacing:.05em;color:var(--muted)}
  .form-group textarea,.form-group input[type="text"],.form-group input[type="date"],.form-group select{width:100%;padding:8px 12px;border:1px solid var(--line);border-radius:3px;font-size:13px;font-family:inherit;background:#fff;transition:border-color 0.2s ease}
  .form-group textarea:focus,.form-group input:focus,.form-group select:focus{outline:none;border-color:var(--hair);box-shadow:0 0 0 2px rgba(0,0,0,0.04)}
  .form-row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .btn-add{padding:8px 16px;border:1px solid var(--line);background:transparent;color:var(--fg);cursor:pointer;border-radius:3px;font-size:12px;transition:all 0.2s ease;margin-top:8px}
  .btn-add:hover{background:var(--line);border-color:var(--hair)}

  /* Obstacle Mapping */
  .obstacle-item,.action-item{margin-bottom:16px;padding:12px;border:1px solid var(--line);border-radius:4px;background:#fff}
  .obstacle-header,.action-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .obstacle-type{display:inline-block;padding:2px 8px;border-radius:12px;font-size:10px;text-transform:uppercase;font-weight:600;background:var(--line);color:var(--muted)}
  .obstacle-type.external{background:#e3f2fd;color:#1976d2}
  .obstacle-type.internal{background:#fff3e0;color:#f57c00}
  .obstacle-strategy{margin-top:8px;padding-top:8px;border-top:1px solid var(--line)}
  .action-checkbox{display:flex;align-items:center;gap:8px}
  .action-checkbox input[type="checkbox"]{width:18px;height:18px;cursor:pointer}
  .action-due{font-size:11px;color:var(--muted);margin-top:4px}
  .btn-remove{background:transparent;border:none;color:var(--muted);cursor:pointer;font-size:18px;padding:0;line-height:1;opacity:0.6;transition:opacity 0.2s ease}
  .btn-remove:hover{opacity:1}

  /* Reflection */
  .confidence-slider-container{display:flex;align-items:center;gap:12px}
  .confidence-slider-container input[type="range"]{flex:1}
  #confidence-value{font-weight:600;min-width:30px;text-align:center}

  /* Add Form Containers */
  .add-form-container{margin-top:16px;padding:16px;background:var(--bg-secondary);border:1px solid var(--line);border-radius:4px}
  .add-form-container.hidden{display:none}
  .form-error{font-size:12px;color:#d63638;margin-top:4px;display:block}
  .form-error.hidden{display:none}

  .previous-answers{margin-bottom:32px;border:1px solid var(--line);border-radius:4px;background:linear-gradient(145deg,#fafafa 0%,#f5f5f5 100%);padding:16px}
  .previous-answers summary{cursor:pointer;user-select:none;display:flex;justify-content:space-between;align-items:center;padding:8px 0}
  .previous-answers summary:hover .summary-text{color:var(--fg)}
  .summary-text{font-size:13px;font-weight:500;color:var(--muted);transition:color 0.2s ease}
  .summary-hint{font-size:11px;color:var(--muted)}
  .answer-list{margin-top:16px;display:flex;flex-direction:column;gap:12px}
  .answer-card{background:#fff;border:1px solid var(--line);border-radius:4px;padding:12px;transition:box-shadow 0.2s ease}
  .answer-card:hover{box-shadow:0 2px 6px rgba(0,0,0,0.06)}
  .answer-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .answer-step{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:var(--fg)}
  .answer-edit{font-size:11px;padding:4px 8px;border:1px solid var(--line);background:transparent;cursor:pointer;border-radius:2px;transition:all 0.2s ease}
  .answer-edit:hover{background:var(--line)}
  .answer-content{font-size:12px;line-height:1.5;color:var(--muted);white-space:pre-wrap}

  .ps101-question{margin-bottom:32px}
  .question-text{font-size:18px;font-weight:400;line-height:1.5;color:var(--fg);margin:0 0 16px}
  .coaching-hint{margin-top:12px;padding:12px;background:linear-gradient(145deg,#fafafa 0%,#f5f5f5 100%);border:1px solid var(--line);border-radius:4px}
  .coaching-hint summary{font-size:12px;cursor:pointer;user-select:none;color:var(--muted)}
  .coaching-hint summary:hover{color:var(--fg)}
  .coaching-hint p{margin:8px 0 0;font-size:12px;line-height:1.5;color:var(--muted)}

  .ps101-input{margin-bottom:24px}
  .step-textarea{width:100%;min-height:120px;padding:12px;border:1px solid var(--line);border-radius:4px;font:inherit;font-size:13px;line-height:1.6;resize:vertical;transition:all 0.2s ease}
  .step-textarea:focus{outline:none;border-color:var(--hair);box-shadow:0 2px 8px rgba(0,0,0,0.08)}
.metrics-note{grid-column:1/-1;font-size:11px;color:var(--muted);margin-top:12px;text-align:right}
.metrics.has-data .metrics-note{display:none}
.char-count{margin-top:8px;font-size:11px;color:var(--muted);text-align:right;transition:color .2s ease}
.char-count .char-min{margin-left:6px;font-style:italic;color:inherit}
.char-count .char-min:empty{display:none}
.char-count.needs-detail{color:#d63638}
.char-count.near-limit{color:#a15c0f}

  .ps101-nav{display:flex;justify-content:space-between;margin-top:32px;gap:16px}
  .nav-btn{min-width:120px;padding:10px 20px;font-size:13px}
  .nav-back{background:transparent;border-color:var(--line)}
  .nav-next{background:linear-gradient(145deg,#fff 0%,#f8f8f8 100%);border-color:var(--hair);font-weight:500}
  .nav-btn:disabled{opacity:0.5;cursor:not-allowed}

  .autosave-indicator{margin-top:16px;text-align:center;font-size:11px;color:var(--muted);opacity:0;transition:opacity 0.3s ease}
  .autosave-indicator.visible{opacity:1}

  .ps101-completion{max-width:var(--max);margin:40px auto;padding:40px 20px}
  .ps101-completion.hidden{display:none}
  .completion-header{text-align:center;margin-bottom:32px}
  .completion-title{font-size:22px;font-weight:600;color:var(--fg);margin:0 0 16px}
  .completion-progress{font-size:16px;color:var(--fg);display:flex;flex-direction:column;align-items:center;gap:8px}
  .completion-label{font-size:12px;color:var(--muted)}
  .completion-message{text-align:center;margin-bottom:32px}
  .completion-message p{font-size:14px;color:var(--muted)}
  .commitment-highlight{background:linear-gradient(145deg,#fafafa 0%,#f5f5f5 100%);border:1px solid var(--line);border-radius:4px;padding:20px;margin-bottom:32px}
  .commitment-label{font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:var(--fg);margin:0 0 12px}
  .commitment-text{font-size:14px;line-height:1.6;color:var(--fg);margin-bottom:8px;white-space:pre-wrap}
  .commitment-deadline{font-size:12px;color:var(--muted);font-weight:500}
  .completion-summary{margin-bottom:32px;border:1px solid var(--line);border-radius:4px;padding:16px}
  .completion-summary summary{cursor:pointer;font-size:13px;font-weight:500;color:var(--muted);user-select:none}

  @media (max-width:768px){
    .ps101-welcome{margin:40px auto;padding:24px 16px}
    .welcome-title{font-size:24px}
    .ps101-container{padding:24px 16px}
    .question-text{font-size:16px}
    .step-textarea{min-height:100px}
    .ps101-nav{flex-direction:column-reverse}
    .nav-btn{width:100%}
    .progress-dots{gap:8px}
    .progress-dots .dot{width:28px;height:28px;font-size:10px}
  }
</style>

<div class="wrap">
  <nav class="nav">
    <a href="javascript:void(0)" onclick="scrollToSection('about')">about</a>
    <a href="javascript:void(0)" onclick="scrollToSection('modules')" title="Modules">modules</a>
    <a href="javascript:void(0)" onclick="scrollToSection('resources')" title="Help & Resources">resources</a>
    <a id="openUpload" data-action="open-upload" class="open-upload-link" href="javascript:void(0)" title="Upload a resume, image, or audio">upload</a>
    <a id="openChat" href="javascript:void(0)" title="Get help">help</a>
    <span class="status working" id="apiStatus">ready</span>
  </nav>

  <!-- LOGIN/REGISTER MODAL -->
  <div id="authModal" class="modal" style="display:none">
    <div class="panel" style="max-width:400px">
      <h2 style="font:600 14px/1.2 Helvetica,Arial;margin:0 0 20px;text-transform:uppercase;letter-spacing:.08em;text-align:center">welcome to your career transition</h2>

      <!-- LOGIN FORM -->
      <form id="loginForm" style="margin-bottom:20px">
        <div style="margin-bottom:16px">
          <label style="display:block;font-size:10px;color:var(--muted);margin-bottom:4px;text-transform:uppercase;letter-spacing:.08em">email</label>
          <input type="email" id="loginEmail" required style="width:100%;padding:8px;border:1px solid var(--line);font-size:12px">
        </div>
        <div style="margin-bottom:16px">
          <label style="display:block;font-size:10px;color:var(--muted);margin-bottom:4px;text-transform:uppercase;letter-spacing:.08em">password</label>
          <input type="password" id="loginPassword" required style="width:100%;padding:8px;border:1px solid var(--line);font-size:12px">
        </div>
        <div style="margin-bottom:16px;text-align:right">
          <a href="#" id="forgotPassword" style="font-size:9px;color:var(--muted);text-decoration:underline">forgot password?</a>
        </div>
        <button type="submit" class="quiet" style="width:100%;padding:10px;font-size:11px;text-transform:uppercase;letter-spacing:.08em;background:var(--hair);color:#fff;border:1px solid var(--hair)">sign in</button>
      </form>

      <!-- REGISTER FORM -->
      <form id="registerForm" style="margin-bottom:20px" hidden>
        <div style="margin-bottom:16px">
          <label style="display:block;font-size:10px;color:var(--muted);margin-bottom:4px;text-transform:uppercase;letter-spacing:.08em">email</label>
          <input type="email" id="registerEmail" required style="width:100%;padding:8px;border:1px solid var(--line);font-size:12px">
        </div>
        <div style="margin-bottom:16px">
          <label style="display:block;font-size:10px;color:var(--muted);margin-bottom:4px;text-transform:uppercase;letter-spacing:.08em">password</label>
          <input type="password" id="registerPassword" required style="width:100%;padding:8px;border:1px solid var(--line);font-size:12px">
        </div>
        <div style="margin-bottom:16px">
          <label style="display:block;font-size:10px;color:var(--muted);margin-bottom:4px;text-transform:uppercase;letter-spacing:.08em">confirm password</label>
          <input type="password" id="registerConfirm" required style="width:100%;padding:8px;border:1px solid var(--line);font-size:12px">
        </div>
        <div style="margin-bottom:16px">
          <label style="display:block;font-size:10px;color:var(--muted);margin-bottom:4px;text-transform:uppercase;letter-spacing:.08em">discount code <span style="color:var(--muted);font-weight:400">(optional)</span></label>
          <input type="text" id="registerDiscountCode" style="width:100%;padding:8px;border:1px solid var(--line);font-size:12px;text-transform:uppercase" placeholder="BETA2025">
        </div>
        <button type="submit" class="quiet" style="width:100%;padding:10px;font-size:11px;text-transform:uppercase;letter-spacing:.08em;background:var(--hair);color:#fff;border:1px solid var(--hair)">create account</button>
      </form>

      <div style="text-align:center;margin-top:16px">
        <button id="toggleAuth" class="quiet" style="padding:6px 12px;font-size:9px;text-transform:uppercase;letter-spacing:.08em">need an account?</button>
      </div>

      <div id="authStatus" class="status" style="margin-top:12px;text-align:center"></div>
    </div>
  </div>

  <!-- PASSWORD RESET MODAL -->
  <div id="resetModal" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;z-index:1001">
    <div style="background:#fff;padding:32px;border-radius:4px;max-width:400px;width:90%;box-shadow:0 8px 30px rgba(0,0,0,.12)">
      <h2 style="font:600 14px/1.2 Helvetica,Arial;margin:0 0 20px;text-transform:uppercase;letter-spacing:.08em;text-align:center">reset password</h2>

      <form id="resetForm" style="margin-bottom:20px">
        <div style="margin-bottom:16px">
          <label style="display:block;font-size:10px;color:var(--muted);margin-bottom:4px;text-transform:uppercase;letter-spacing:.08em">email</label>
          <input type="email" id="resetEmail" required style="width:100%;padding:8px;border:1px solid var(--line);font-size:12px">
        </div>
        <button type="submit" class="quiet" style="width:100%;padding:10px;font-size:11px;text-transform:uppercase;letter-spacing:.08em;background:var(--hair);color:#fff;border:1px solid var(--hair)">send reset link</button>
      </form>

      <div style="text-align:center;margin-top:16px">
        <button id="closeReset" class="quiet" style="padding:6px 12px;font-size:9px;text-transform:uppercase;letter-spacing:.08em">cancel</button>
      </div>

      <div id="resetStatus" class="status" style="margin-top:12px;text-align:center"></div>
    </div>
  </div>

  <!-- INTRO SECTION -->
  <section class="intro-process">
    <h2>How This Works</h2>
    <p>Three simple steps to get unstuck in your career:</p>
    <div class="process-steps">
      <div class="step">
        <strong>1. Quick Questions</strong>
        <span>What's your situation? What do you want? What's blocking you?</span>
      </div>
      <div class="step">
        <strong>2. Explore Your Options</strong>
        <span>Look at jobs, improve your resume, make a plan</span>
      </div>
      <div class="step">
        <strong>3. Stay Moving</strong>
        <span>Check in weekly to keep making progress</span>
      </div>
    </div>
    <p><strong>Time needed:</strong> 15-30 minutes to start, then as needed</p>
  </section>

  <!-- USER INPUT -->
  <div class="coach-strip">
    <span>ask</span>
    <input id="coachAsk" placeholder="type a question or try: help me get started" autocomplete="off">
    <button id="voiceBtn" class="quiet" title="Voice input">üé§</button>
    <button id="coachSend" class="quiet" type="button">ask</button>
  </div>

  <!-- WELCOME / INTRO -->
  <section id="welcome" class="island" aria-label="Welcome">
    <div class="welcome-title" title="career clarity platform">what is my delta</div>
    <p class="sub" title="what this is">Feeling stuck in your career? Start with a few questions to get clear on what you want and how to get there.</p>
    <div class="actions">
      <button class="quiet" id="linkFast" title="guided route: key questions ‚Üí action planning ‚Üí progress tracking">start with questions</button>
      <button class="quiet" id="linkDiscover" title="explore different sections as you like">explore on my own</button>
      <button class="quiet" id="showJourney" title="show all sections">see everything</button>
      <button class="quiet" id="saveBtn" title="Save progress to file">save</button>
      <label class="quiet" for="loadFile" title="Load a saved file">load<input id="loadFile" type="file" accept="application/json" hidden></label>
      <button class="quiet" id="showAuthModal" title="Sign up or log in to save progress permanently" style="display:none">sign up / log in</button>
    </div>
    <details class="micro"><summary>what's the difference?</summary>
      <small><strong>Start with questions:</strong> 5-10 minutes of guided questions to get clarity, then make a plan.<br>
      <strong>Explore on my own:</strong> Jump to any section - job search, resume work, or planning.</small>
    </details>
  </section>

  <header class="hero" id="top">
    <div class="title">WHAT IS MY DELTA</div>
    <p class="sub">Answer a few questions. Get clear on your next career move. Take action.</p>
  </header>

  <svg class="schema" viewBox="0 0 980 140" aria-hidden="true">
    <path class="wire" d="M120 90 H360 C400 90 420 78 450 70 C480 62 520 60 560 68 C600 76 640 60 700 58 C820 54 860 54 900 56"/>
    <circle class="dot" cx="120" cy="90" r="1.2"/>
  </svg>

  <div class="rule"></div>

  <section class="metrics" id="metricsSection" aria-label="Metrics">
    <div class="card"><div class="k">Clarity</div><div class="v" id="mClarity">‚Äî</div></div>
    <div class="card"><div class="k">Action</div><div class="v" id="mAction">‚Äî</div></div>
    <div class="card"><div class="k">Momentum</div><div class="v" id="mMomentum">‚Äî</div></div>
    <div class="metrics-note" id="metricsNote">Complete Step‚ÄØ1 to unlock metrics.</div>
  </section>

  <section id="modules" class="island" aria-label="Modules">
    <div class="module" id="ps101">
      <h3><a href="javascript:void(0)" onclick="scrollToSection('ps101')" title="open PS101">Get Started ‚Äî Quick Questions</a></h3>
      <ul>
        <li>What's your current career challenge? <span class="tooltip" data-tip="Feeling stuck, want to change roles, looking for promotion, etc.">?</span></li>
        <li>What would success look like for you? <span class="tooltip" data-tip="New job, better pay, different industry, work-life balance, etc.">?</span></li>
        <li>What's your biggest obstacle right now? <span class="tooltip" data-tip="Time, skills, network, confidence, unclear direction, etc.">?</span></li>
      </ul>
      <textarea class="small" placeholder="write your thoughts as you work through these questions‚Ä¶" id="t_ps101" aria-label="Career questions notes"></textarea>
      <div class="module-actions">
        <a href="javascript:void(0)" data-prompt="help me get started with these questions">start here</a>
      </div>
    </div>

    <div class="module" id="progress">
      <h3><a href="javascript:void(0)" onclick="scrollToSection('progress')" title="open Progress">Stay on Track ‚Äî Weekly Check-ins</a></h3>
      <ul>
        <li>Weekly progress review <span class="tooltip" data-tip="What got done, what didn't, what's working">?</span></li>
        <li>Action item tracking <span class="tooltip" data-tip="Specific next steps with deadlines">?</span></li>
        <li>Problem solving <span class="tooltip" data-tip="When you get stuck, work through obstacles">?</span></li>
      </ul>
      <textarea class="small" placeholder="what you're working on, what's working, what's stuck‚Ä¶" id="t_progress" aria-label="Progress notes"></textarea>
      <div class="module-actions">
        <a href="javascript:void(0)" data-prompt="help me figure out what to focus on this week">plan next steps</a>
      </div>
    </div>

    <div class="module" id="jobs">
      <h3><a href="javascript:void(0)" onclick="scrollToSection('jobs')" title="open Jobs">Job Search ‚Äî Compare Opportunities</a></h3>
      <ul>
        <li>Compare different roles <span class="tooltip" data-tip="Side-by-side comparison of responsibilities, growth potential, company culture">?</span></li>
        <li>Skills alignment check <span class="tooltip" data-tip="How well your background matches what they're looking for">?</span></li>
        <li>Warning signs to watch <span class="tooltip" data-tip="Red flags: unrealistic requirements, vague job descriptions, high turnover, poor reviews">?</span></li>
      </ul>
      <textarea class="small" placeholder="job titles, companies, what interests you, what concerns you‚Ä¶" id="t_jobs" aria-label="Job search notes"></textarea>
      <div class="module-actions">
        <a href="javascript:void(0)" data-prompt="help me compare these job opportunities">compare jobs</a>
        <a href="javascript:void(0)" id="findJobs" title="Find relevant jobs">find jobs</a>
      </div>
    </div>

    <div class="module" id="resume">
      <h3><a href="javascript:void(0)" onclick="scrollToSection('resume')" title="open Resume">Resume ‚Äî Tell Your Story</a></h3>
      <ul>
        <li>Highlight your best examples <span class="tooltip" data-tip="Pick 3-5 accomplishments that show results and growth">?</span></li>
        <li>Format for applications <span class="tooltip" data-tip="Clean, scannable format that works with applicant tracking systems">?</span></li>
        <li>Be truthful but compelling <span class="tooltip" data-tip="Honest about experience while presenting your strongest case">?</span></li>
      </ul>
      <textarea class="small" placeholder="your experiences, accomplishments, what you want to emphasize‚Ä¶" id="t_resume" aria-label="Resume notes"></textarea>
      <div class="module-actions">
        <a href="javascript:void(0)" data-prompt="help me write about this experience clearly">improve my resume</a>
        <a href="javascript:void(0)" class="open-upload-link" data-action="open-upload" title="Upload an existing resume to refine">upload resume</a>
      </div>
    </div>

    <div class="module" id="dashboard">
      <h3><a href="javascript:void(0)" onclick="scrollToSection('dashboard')" title="open Dashboard">Delta ‚Äî Dashboard</a></h3>
      <ul><li>Clarity score</li><li>Action trend</li><li>Next steps</li></ul>
      <textarea class="small" placeholder="next step (one thing to do)‚Ä¶" id="t_dashboard" aria-label="Dashboard notes"></textarea>
      <div class="module-actions">
        <a href="javascript:void(0)" data-prompt="suggest 1 next step from my notes">suggest next step</a>
      </div>
    </div>
  </section>

  <div class="rule"></div>

  <!-- PS101 Welcome Screen -->
  <div class="ps101-welcome hidden" id="ps101-welcome">
    <div class="welcome-content">
      <h1 class="welcome-title">Welcome to PS101</h1>
      <p class="welcome-subtitle">Problem Solving 101</p>

      <div class="welcome-description">
        <p>A 7-step framework to get clarity on your career challenge and create an action plan.</p>

        <ul class="welcome-features">
          <li>‚è± Takes 15-30 minutes</li>
          <li>üíæ Progress auto-saves</li>
          <li>‚úèÔ∏è Edit previous answers anytime</li>
        </ul>
      </div>

      <div class="welcome-actions">
        <button class="quiet welcome-btn-primary" id="start-ps101">
          Start PS101 Flow
        </button>

        <button class="quiet welcome-btn-secondary" id="learn-more-ps101">
          Learn More
        </button>
      </div>

      <div class="welcome-resume hidden" id="welcome-resume">
        <p class="resume-text">Already started? Your progress is saved.</p>
        <button class="quiet" id="continue-ps101">
          Continue Where I Left Off
        </button>
      </div>
    </div>
  </div>

  <!-- PS101 Flow Container -->
  <section id="ps101-flow" class="ps101-container hidden" aria-label="PS101 Coaching Flow">
    <!-- Progress indicator -->
    <div class="ps101-progress" role="navigation" aria-label="Progress">
      <div class="progress-header">
        <span class="step-label" id="step-label">Step 1 of 10: Problem Identification and Delta Analysis</span>
      </div>
      <div class="progress-dots">
        <button class="dot active" aria-label="Step 1: Problem Identification and Delta Analysis (current)" aria-current="step" data-step="1">1</button>
        <button class="dot" aria-label="Step 2: Current Situation Analysis" data-step="2">2</button>
        <button class="dot" aria-label="Step 3: Root Cause Exploration" data-step="3">3</button>
        <button class="dot" aria-label="Step 4: Self-Efficacy Assessment" data-step="4">4</button>
        <button class="dot" aria-label="Step 5: Solution Brainstorming" data-step="5">5</button>
        <button class="dot" aria-label="Step 6: Experimental Design" data-step="6">6</button>
        <button class="dot" aria-label="Step 7: Obstacle Identification" data-step="7">7</button>
        <button class="dot" aria-label="Step 8: Action Planning" data-step="8">8</button>
        <button class="dot" aria-label="Step 9: Reflection and Iteration" data-step="9">9</button>
        <button class="dot" aria-label="Step 10: Building Mastery and Self-Efficacy" data-step="10">10</button>
      </div>
    </div>

    <!-- Previous answers (expandable) -->
    <details class="previous-answers hidden" id="previous-answers">
      <summary>
        <span class="summary-text">‚ñº Previous Answers (0 steps completed)</span>
        <span class="summary-hint">Click to review or edit</span>
      </summary>
      <div class="answer-list"></div>
    </details>

    <!-- Current step question -->
    <div class="ps101-question" id="ps101-question">
      <h2 class="question-text" id="question-text">
        <!-- Dynamic: Current step question -->
      </h2>

      <!-- Optional coaching hint -->
      <details class="coaching-hint" id="coaching-hint">
        <summary>üí° Coaching Hint</summary>
        <p id="hint-text">
          <!-- Dynamic: Step-specific guidance -->
        </p>
      </details>
    </div>

    <!-- User input area -->
    <div class="ps101-input" id="ps101-input">
      <textarea
        id="step-answer"
        class="step-textarea"
        placeholder="Type your answer here..."
        aria-label="Your answer"
        rows="6"
      ></textarea>
      <div class="char-count" id="char-count" aria-live="polite">
        <span id="char-current">0</span> / <span id="char-max">500</span>
        <span id="char-min" class="char-min"></span>
      </div>
    </div>

    <!-- Experiment Components (Steps 6-9) -->
    <div class="experiment-components hidden" id="experiment-components">
      <!-- Step 6: Experiment Canvas -->
      <div class="experiment-canvas hidden" id="experiment-canvas">
        <h3 class="component-title">Experiment Design</h3>
        <div class="experiment-form">
          <div class="form-group">
            <label for="exp-hypothesis">Hypothesis</label>
            <textarea id="exp-hypothesis" rows="3" placeholder="What are you testing?"></textarea>
          </div>
          <div class="form-group">
            <label for="exp-success-metric">Success Metric</label>
            <input type="text" id="exp-success-metric" placeholder="What measurable outcome indicates success?">
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="exp-start-date">Start Date</label>
              <input type="date" id="exp-start-date">
            </div>
            <div class="form-group">
              <label for="exp-review-date">Review Date</label>
              <input type="date" id="exp-review-date">
            </div>
          </div>
          <div class="form-group">
            <label for="exp-resources">Resources/Support Needed</label>
            <textarea id="exp-resources" rows="2" placeholder="What do you need to run this experiment?"></textarea>
          </div>
        </div>
      </div>

      <!-- Step 7: Obstacle Mapping -->
      <div class="obstacle-mapping hidden" id="obstacle-mapping">
        <h3 class="component-title">Obstacle Identification</h3>
        <div id="obstacles-list"></div>
        <button class="btn-add" id="add-obstacle-btn">+ Add Obstacle</button>
        <!-- Add Obstacle Form (hidden by default) -->
        <div id="add-obstacle-form" class="hidden add-form-container">
          <h4 style="margin: 0 0 12px 0; font-size: 14px; font-weight: 600; color: var(--fg);">Add Obstacle</h4>
          <div class="form-group">
            <label for="obstacle-label">What obstacle do you anticipate? *</label>
            <input
              type="text"
              id="obstacle-label"
              placeholder="e.g., Limited time availability"
              aria-required="true"
              aria-describedby="obstacle-label-error"
            />
            <span id="obstacle-label-error" class="form-error hidden" role="alert"></span>
          </div>
          <div class="form-group">
            <label style="margin-bottom: 8px;">Obstacle Type</label>
            <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; font-weight: normal; text-transform: none; letter-spacing: normal;">
              <input type="radio" name="obstacle-type" value="external" checked />
              External (e.g., time, resources, other people)
            </label>
            <label style="display: flex; align-items: center; gap: 8px; font-weight: normal; text-transform: none; letter-spacing: normal;">
              <input type="radio" name="obstacle-type" value="internal" />
              Internal (e.g., self-doubt, fear, lack of knowledge)
            </label>
          </div>
          <div class="form-group">
            <label for="obstacle-strategy">Strategy to overcome this obstacle *</label>
            <textarea
              id="obstacle-strategy"
              rows="3"
              placeholder="How will you mitigate this?"
              aria-required="true"
              aria-describedby="obstacle-strategy-error"
            ></textarea>
            <span id="obstacle-strategy-error" class="form-error hidden" role="alert"></span>
          </div>
          <div style="display: flex; gap: 8px; margin-top: 8px;">
            <button id="save-obstacle-btn" class="quiet" style="flex: 1;">Add Obstacle</button>
            <button id="cancel-obstacle-btn" class="quiet" style="flex: 1;">Cancel</button>
          </div>
        </div>
      </div>

      <!-- Step 8: Action Plan -->
      <div class="action-plan hidden" id="action-plan">
        <h3 class="component-title">Action Plan</h3>
        <div id="actions-list"></div>
        <button class="btn-add" id="add-action-btn">+ Add Action Item</button>
        <!-- Add Action Form (hidden by default) -->
        <div id="add-action-form" class="hidden add-form-container">
          <h4 style="margin: 0 0 12px 0; font-size: 14px; font-weight: 600; color: var(--fg);">Add Action Item</h4>
          <div class="form-group">
            <label for="action-label">What action will you take? *</label>
            <input
              type="text"
              id="action-label"
              placeholder="e.g., Schedule 30-min focus block daily"
              aria-required="true"
              aria-describedby="action-label-error"
            />
            <span id="action-label-error" class="form-error hidden" role="alert"></span>
          </div>
          <div class="form-group">
            <label for="action-due">By when?</label>
            <input
              type="text"
              id="action-due"
              placeholder="e.g., 2025-11-15 or 'Next Friday'"
            />
          </div>
          <div class="form-group">
            <label for="action-accountability">Who can help hold you accountable? (optional)</label>
            <input
              type="text"
              id="action-accountability"
              placeholder="e.g., My mentor, Team lead"
            />
          </div>
          <div style="display: flex; gap: 8px; margin-top: 8px;">
            <button id="save-action-btn" class="quiet" style="flex: 1;">Add Action</button>
            <button id="cancel-action-btn" class="quiet" style="flex: 1;">Cancel</button>
          </div>
        </div>
      </div>

      <!-- Step 9: Reflection Log -->
      <div class="reflection-log hidden" id="reflection-log">
        <h3 class="component-title">Reflection & Learning</h3>
        <div class="form-group">
          <label for="reflection-outcome">Outcomes</label>
          <textarea id="reflection-outcome" rows="4" placeholder="What were the results of your experiment?"></textarea>
        </div>
        <div class="form-group">
          <label for="reflection-learning">Learning Summary</label>
          <textarea id="reflection-learning" rows="4" placeholder="What did you learn?"></textarea>
        </div>
        <div class="form-group">
          <label for="reflection-confidence">Confidence After (1-10)</label>
          <input type="range" id="reflection-confidence" min="1" max="10" value="5">
          <span id="confidence-value">5</span>
        </div>
        <div class="form-group">
          <label for="reflection-next-move">Next Move</label>
          <select id="reflection-next-move">
            <option value="Continue">Continue</option>
            <option value="Pivot">Pivot</option>
            <option value="Archive">Archive</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Navigation -->
    <div class="ps101-nav">
      <button class="nav-btn nav-back quiet" id="ps101-back" aria-label="Go back to previous step">
        ‚Üê Back
      </button>

      <button class="nav-btn nav-next quiet" id="ps101-next" aria-label="Continue to next step">
        Next ‚Üí
      </button>
    </div>

    <!-- Auto-save indicator -->
    <div class="autosave-indicator" id="autosave-indicator" aria-live="polite">
      <span class="autosave-text">Saved</span>
    </div>
  </section>

  <!-- PS101 Completion Screen -->
  <div class="ps101-completion hidden" id="ps101-completion">
    <div class="completion-header">
      <h2 class="completion-title">PS101 Complete ‚Äî Your Action Plan</h2>
      <div class="completion-progress">
        ‚óè ‚óè ‚óè ‚óè ‚óè ‚óè ‚óè ‚óè ‚óè ‚óè
        <span class="completion-label">All 10 steps completed</span>
      </div>
    </div>

    <div class="completion-message">
      <p>Well done! You've created a clear action plan.</p>
    </div>

    <!-- Highlighted commitment -->
    <div class="commitment-highlight">
      <h3 class="commitment-label">Your Next Commitment (Step 7):</h3>
      <div class="commitment-text" id="commitment-text">
        <!-- Dynamic: User's Step 7 answer -->
      </div>
      <div class="commitment-deadline" id="commitment-deadline">
        <!-- Dynamic: Deadline if provided -->
      </div>
    </div>

    <!-- Expandable full summary -->
    <details class="completion-summary" open>
      <summary>‚ñº View All Answers</summary>
      <div class="answer-list" id="completion-answers">
        <!-- Dynamic: All 7 steps with answers -->
      </div>
    </details>

    <!-- Actions -->
    <div class="welcome-actions" style="margin-top:32px">
      <button class="quiet" id="download-summary">Download Summary</button>
      <button class="quiet" id="start-over">Start Over</button>
    </div>
  </div>

  <div class="rule"></div>

  <section id="resources" class="island" aria-label="Resources">
    <div class="welcome-title">Resources & Help</div>
    <div class="resource-grid">
      <div>
        <h4>Getting Started</h4>
        <ul>
          <li><a href="javascript:void(0)" onclick="scrollToSection('guide')">Complete User Guide</a></li>
          <li><a href="javascript:void(0)" onclick="scrollToSection('examples')">Example Questions & Answers</a></li>
          <li><a href="https://www.themuse.com/advice/how-to-change-careers" target="_blank" rel="noopener">Career Change Tips</a></li>
        </ul>
      </div>
      <div>
        <h4>Job Search</h4>
        <ul>
          <li><a href="https://www.linkedin.com/jobs/" target="_blank" rel="noopener">LinkedIn Jobs</a> ¬∑ <a href="https://www.indeed.com/" target="_blank" rel="noopener">Indeed</a> ¬∑ <a href="https://wellfound.com/jobs" target="_blank" rel="noopener">Wellfound (startups)</a> ¬∑ <a href="https://www.idealist.org/en/jobs" target="_blank" rel="noopener">Idealist (non-profits)</a></li>
          <li><a href="https://docs.google.com/document/d/1NY0xLCR6w3eHTZkW81jqKf-I7qVYdltBC0b-TnUR0Hg/edit?usp=sharing" target="_blank" rel="noopener">Networking Email Templates (Copy)</a></li>
          <li><a href="https://careersidekick.com/star-interview-method/" target="_blank" rel="noopener">Interview Preparation (STAR Method)</a></li>
        </ul>
      </div>
      <div>
        <h4>Resume & Applications</h4>
        <ul>
          <li><a href="https://www.jobhero.com/resume-templates" target="_blank" rel="noopener">Resume Templates</a></li>
          <li><a href="https://cultivatedculture.com/cover-letter-examples/" target="_blank" rel="noopener">Cover Letter Examples</a></li>
          <li><a href="https://www.notion.so/blog/how-to-build-a-portfolio" target="_blank" rel="noopener">Portfolio Guidelines</a></li>
        </ul>
      </div>
    </div>

    <div id="guide" class="help-section">
      <h3>How This Platform Works</h3>
      <div class="process-flow">
        <div class="flow-step">
          <div class="step-number">1</div>
          <div class="step-content">
            <strong>Start with Questions</strong>
            <p>Answer 3 key questions about your career situation. This takes 5-10 minutes and gives you clarity on what you want.</p>
            <small>Time: 5-10 minutes</small>
          </div>
        </div>
        <div class="flow-arrow">‚Üí</div>
        <div class="flow-step">
          <div class="step-number">2</div>
          <div class="step-content">
            <strong>Explore Your Options</strong>
            <p>Use the tools to compare jobs, improve your resume, or plan next steps. Work on what feels most important.</p>
            <small>Time: 15-30 minutes</small>
          </div>
        </div>
        <div class="flow-arrow">‚Üí</div>
        <div class="flow-step">
          <div class="step-number">3</div>
          <div class="step-content">
            <strong>Stay on Track</strong>
            <p>Check in weekly to review progress and plan your next actions. Keep moving forward.</p>
            <small>Time: 10-15 minutes weekly</small>
          </div>
        </div>
      </div>
    </div>

    <div id="examples" class="help-section">
      <h3>Example Questions & Answers</h3>
      <div class="example-qa">
        <div class="question">What's your current career challenge?</div>
        <div class="example-answer">"I feel stuck in my current role. I've been doing the same work for 3 years and want to move into management, but don't know how to make the transition."</div>
      </div>
      <div class="example-qa">
        <div class="question">What would success look like for you?</div>
        <div class="example-answer">"Leading a small team, having more influence on project direction, and earning $20k more within 2 years."</div>
      </div>
      <div class="example-qa">
        <div class="question">What's your biggest obstacle right now?</div>
        <div class="example-answer">"I don't have management experience on my resume and don't know how to get it in my current company."</div>
      </div>
    </div>
  </section>

  <section id="about" class="island" aria-label="About">
    <div class="welcome-title">About What Is My Delta</div>
    <p>A practical career guidance platform designed to help you get unstuck and move forward in your career.</p>

    <h3>What This Platform Does</h3>
    <p>Instead of overwhelming you with generic career advice, we focus on three simple questions that cut through the noise:</p>
    <ul>
      <li><strong>What's your current challenge?</strong> - Get clear on what's actually blocking you</li>
      <li><strong>What would success look like?</strong> - Define your specific career goals</li>
      <li><strong>What's your biggest obstacle?</strong> - Identify what needs to change</li>
    </ul>

    <h3>The PS101 Methodology</h3>
    <p>Our approach is based on PS101 (Problem Solving 101) - a straightforward framework that prioritizes action over analysis paralysis:</p>
    <div class="methodology-steps">
      <div class="method-step">
        <strong>1. Clarity First</strong>
        <p>Start with honest self-assessment. No sugarcoating, no wishful thinking - just clear understanding of where you are.</p>
      </div>
      <div class="method-step">
        <strong>2. Practical Action</strong>
        <p>Focus on what you can actually do this week. Small, concrete steps that move you forward.</p>
      </div>
      <div class="method-step">
        <strong>3. Regular Check-ins</strong>
        <p>Weekly progress reviews to stay on track and adjust course when needed.</p>
      </div>
    </div>

    <h3>Why It Works</h3>
    <p>Most career advice tries to solve everything at once. We believe in tackling one clear problem at a time with specific, actionable steps. No fluff, no corporate speak - just practical guidance that fits into your real life.</p>

    <h3>Your Data, Your Control</h3>
    <p>Everything you enter stays on your device unless you choose to share it. You can save your progress, export your responses, or start fresh anytime. We're here to help you think through your career, not collect your data.</p>

    <h3>About Me</h3>
    <p>I'm Damian, founder of Alacrity Learning and Performance, and I built this platform after spending years helping people navigate career transitions. I've seen too many talented people get stuck - not because they lack skills or ambition, but because career advice often makes things more complicated than they need to be.</p>

    <p>The PS101 methodology came from working with hundreds of professionals who just needed a clear way to think through their next move. Instead of lengthy assessments or abstract frameworks, I wanted something practical: three questions that cut through the noise and get you moving forward.</p>

    <p>This isn't backed by venture capital or designed for massive scale. It's a straightforward tool for people who want to make thoughtful career decisions without the overwhelm. Your progress stays private, your data stays yours, and the focus remains on practical next steps rather than endless analysis.</p>

    <p>If you find this helpful, great. If not, no worries - there are many paths to career clarity, and this is just one approach that's worked for the people I've had the privilege to work with.</p>

    <h4>Get In Touch</h4>
    <p>Questions about the platform or want to share feedback? You can reach me at <span id="emailContact"></span> - I read every message and try to respond within a few days.</p>

    <div class="contact-form" style="margin-top:20px;padding:20px;border:1px solid var(--line);border-radius:4px;background:#fafafa">
      <h5 style="margin:0 0 16px;font-size:12px;text-transform:uppercase;letter-spacing:0.05em">Send a Message</h5>
      <form id="contactForm" name="contact" method="POST" data-netlify="true" netlify-honeypot="bot-field">
        <input type="hidden" name="form-name" value="contact">
        <div style="display:none">
          <label>Don't fill this out if you're human: <input name="bot-field"></label>
        </div>
        <div class="formrow">
          <label for="contactName" style="display:block;margin-bottom:4px;font-size:11px;color:var(--muted)">Name</label>
          <input type="text" id="contactName" required style="width:100%;padding:8px;border:1px solid var(--line);border-radius:2px;font:inherit">
        </div>
        <div class="formrow">
          <label for="contactEmail" style="display:block;margin-bottom:4px;font-size:11px;color:var(--muted)">Email</label>
          <input type="email" id="contactEmail" required style="width:100%;padding:8px;border:1px solid var(--line);border-radius:2px;font:inherit">
        </div>
        <div class="formrow">
          <label for="contactSubject" style="display:block;margin-bottom:4px;font-size:11px;color:var(--muted)">Subject</label>
          <select id="contactSubject" required style="width:100%;padding:8px;border:1px solid var(--line);border-radius:2px;font:inherit;background:#fff">
            <option value="">Choose a topic...</option>
            <option value="feedback">Platform Feedback</option>
            <option value="bug">Bug Report</option>
            <option value="question">General Question</option>
            <option value="partnership">Partnership/Collaboration</option>
            <option value="other">Other</option>
          </select>
        </div>
        <div class="formrow">
          <label for="contactMessage" style="display:block;margin-bottom:4px;font-size:11px;color:var(--muted)">Message</label>
          <textarea id="contactMessage" required rows="4" style="width:100%;padding:8px;border:1px solid var(--line);border-radius:2px;font:inherit;resize:vertical"></textarea>
        </div>
        <div class="formrow" style="margin-top:16px">
          <button type="submit" class="quiet" style="padding:8px 16px">Send Message</button>
          <span id="contactStatus" style="margin-left:16px;font-size:11px"></span>
        </div>
      </form>
    </div>
  </section>

  <section id="privacy" class="island" aria-label="Privacy">
    <div class="welcome-title">Privacy Policy</div>
    <p>Your privacy is important to us. Here's what you need to know:</p>
    <ul>
      <li><strong>Data Storage:</strong> All your responses are saved locally in your browser. Nothing is sent to our servers unless you choose to submit feedback.</li>
      <li><strong>Optional Sharing:</strong> You can optionally contribute anonymous data to help improve the platform.</li>
      <li><strong>No Tracking:</strong> We don't use cookies or tracking pixels to monitor your behavior.</li>
      <li><strong>Your Control:</strong> You can export your data or delete it at any time using the save/load features.</li>
    </ul>
  </section>

  <!-- FEEDBACK -->
  <section id="feedback" class="island" aria-label="Feedback">
    <div class="welcome-title" title="tell us, briefly">feedback</div>
    <p class="sub">this helps us tune the welcome + flow. optional, quick.</p>

    <div class="formrow">
      <div class="k">intro clarity</div>
      <div class="radio">
        <label><input type="radio" name="fb_clarity" value="very clear"> very clear</label>
        <label><input type="radio" name="fb_clarity" value="somewhat"> somewhat</label>
        <label><input type="radio" name="fb_clarity" value="unclear"> unclear</label>
      </div>
    </div>

    <div class="formrow">
      <div class="k">felt welcomed</div>
      <div class="radio">
        <label><input type="radio" name="fb_welcome" value="yes"> yes</label>
        <label><input type="radio" name="fb_welcome" value="partly"> partly</label>
        <label><input type="radio" name="fb_welcome" value="not really"> not really</label>
      </div>
    </div>

    <div class="formrow">
      <div class="k">preferred path</div>
      <div class="radio">
        <label><input type="radio" name="fb_path" value="fast track"> fast track</label>
        <label><input type="radio" name="fb_path" value="discovery"> discovery</label>
        <label><input type="radio" name="fb_path" value="unsure"> unsure</label>
      </div>
    </div>

    <div class="formrow">
      <div class="k">one thing to improve</div>
      <textarea id="fb_comment" class="small" placeholder="tiny note‚Ä¶" aria-label="Feedback comment"></textarea>
    </div>

    <div class="actions" style="margin-top:20px">
      <button id="fbSubmit" class="quiet" title="download a copy + (optional) open SurveyMonkey">submit feedback</button>
    </div>
  </section>

  <div class="notice" id="saveNotice" aria-live="polite">
    <div>save before you leave?</div>
    <div style="display:flex;gap:8px">
      <button class="btn" id="noticeSave">save now</button>
      <button class="btn" id="noticeDismiss">dismiss</button>
    </div>
  </div>

  <footer class="foot">
    <div>What Is My Delta ‚Äî A project by Alacrity Learning and Performance</div>
    <div>
      <a href="javascript:void(0)" onclick="scrollToSection('resources')">Help</a> ¬∑
      <a href="javascript:void(0)" onclick="scrollToSection('privacy')">Privacy</a> ¬∑
      <a href="javascript:void(0)" onclick="scrollToSection('feedback')">Feedback</a>
    </div>
  </footer>
</div>

<!-- CHAT -->
<aside class="chat" id="chat" role="dialog" aria-labelledby="chatTitle">
  <header>
    <div id="chatTitle">help</div>
    <button class="x" id="closeChat" title="Close" aria-label="Close help">√ó</button>
  </header>
  <main id="chatLog" aria-live="polite"></main>
  <footer>
    <input id="chatInput" placeholder="ask anything‚Ä¶" aria-label="help input" autocomplete="off">
    <button class="btn" id="sendMsg">ask</button>
  </footer>
</aside>

<button id="floatingAuthBtn" class="auth-floating" type="button" aria-label="Sign up or log in">
  sign up / log in
</button>

<!-- UPLOAD MODAL -->
<div class="modal" id="uploadModal" role="dialog" aria-labelledby="uploadTitle">
  <div class="panel">
    <h3 id="uploadTitle" style="margin-bottom:16px">Upload Files</h3>
    <div class="drop" id="dropZone">
      <div style="margin-bottom:10px">upload a resume, image, or audio</div>
      <input type="file" id="filePick" multiple accept=".pdf,.docx,.txt,.mp3,.wav,.jpg,.jpeg,.png">
      <div style="margin-top:8px;font-size:11px;color:var(--muted)">drag files here or click to select</div>
    </div>
    <div id="uploadStatus" style="margin-top:12px;display:none" aria-live="polite">
      <div style="font-size:11px;color:var(--muted)">uploading...</div>
    </div>
    <button class="close" id="closeUpload">close</button>
  </div>
</div>

<noscript>
  <div style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);z-index:10000;display:flex;align-items:center;justify-content:center;padding:20px">
    <div style="background:#fff;padding:40px;max-width:600px;border-radius:8px;text-align:center">
      <h2 style="color:#d32f2f;margin:0 0 20px;font-size:24px">JavaScript Required</h2>
      <p style="margin:0 0 20px;font-size:16px;line-height:1.6">This site requires JavaScript to function. Please enable JavaScript in your browser settings.</p>

      <details style="text-align:left;margin:20px 0;padding:15px;background:#f5f5f5;border-radius:4px">
        <summary style="cursor:pointer;font-weight:600;margin-bottom:10px">How to enable JavaScript in Chrome</summary>
        <ol style="margin:10px 0 0 20px;line-height:1.8">
          <li>Click the three dots menu (‚ãÆ) in the top right</li>
          <li>Go to <strong>Settings</strong></li>
          <li>Click <strong>Privacy and security</strong></li>
          <li>Click <strong>Site Settings</strong></li>
          <li>Click <strong>JavaScript</strong></li>
          <li>Select <strong>"Sites can use JavaScript"</strong></li>
          <li>Refresh this page</li>
        </ol>
      </details>

      <details style="text-align:left;margin:20px 0;padding:15px;background:#f5f5f5;border-radius:4px">
        <summary style="cursor:pointer;font-weight:600;margin-bottom:10px">How to enable JavaScript in Firefox</summary>
        <ol style="margin:10px 0 0 20px;line-height:1.8">
          <li>Type <strong>about:config</strong> in the address bar</li>
          <li>Click <strong>"Accept the Risk and Continue"</strong></li>
          <li>Search for <strong>javascript.enabled</strong></li>
          <li>Make sure it's set to <strong>true</strong></li>
          <li>Refresh this page</li>
        </ol>
      </details>

      <details style="text-align:left;margin:20px 0;padding:15px;background:#f5f5f5;border-radius:4px">
        <summary style="cursor:pointer;font-weight:600;margin-bottom:10px">How to enable JavaScript in Safari</summary>
        <ol style="margin:10px 0 0 20px;line-height:1.8">
          <li>Open Safari menu ‚Üí <strong>Preferences</strong></li>
          <li>Click the <strong>Security</strong> tab</li>
          <li>Check <strong>"Enable JavaScript"</strong></li>
          <li>Refresh this page</li>
        </ol>
      </details>

      <p style="margin:20px 0 0;font-size:14px;color:#666">
        <strong>Supported browsers:</strong> Chrome 88+, Firefox 78+, Safari 14+, Edge 88+
      </p>
    </div>
  </div>
</noscript>

<!-- Phase 1 Modularization: Load extracted modules -->
<script type="module" src="./js/main.js"></script>

<script>
(async function(){
  console.log('[IIFE] Starting execution');

  // NEW: Call modules before anything else
  if (window.__WIMD_MODULES__) {
    await window.__WIMD_MODULES__.initModules();
  }

  // Phase 1 Modularization: Wait for modules to load, then bridge to IIFE
  // The modules export to window.__WIMD_MODULES__ for IIFE access
  // This allows gradual migration without breaking existing code
  const $ = (s, r=document) => r.querySelector(s);
  const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));
  const API_BASE = '';  // Use Netlify proxies; absolute base resolved via ensureConfig()

  // Authentication variables
  const SESSION_KEY = 'delta_session_id';
  const USER_DATA_KEY = 'delta_user_data';
  const TRIAL_START_KEY = 'delta_trial_start';
  const TRIAL_DURATION = 5 * 60 * 1000; // 5 minutes in milliseconds
  let sessionId = localStorage.getItem(SESSION_KEY) || '';
  let apiBase = '';
  let configPromise = null;
  let isAuthenticated = false;
  let currentUser = null;
  let trialStartTime = localStorage.getItem(TRIAL_START_KEY);
  let userData = JSON.parse(localStorage.getItem(USER_DATA_KEY) || '{}');
  let autoSaveInterval = null;

  if(sessionId) {
    document.body.dataset.session = sessionId;
  }

  // Load career coaching knowledge base + PS101 framework
  let careerPrompts = [];
  let ps101Framework = [];

  async function loadPrompts() {
    try {
      // Load 607 career coaching responses
      const csvResponse = await fetch('./assets/prompts.csv');
      const csvText = await csvResponse.text();
      const lines = csvText.split('\n').slice(1); // Skip header

      // Proper CSV parsing for CoachVox AI structure with embedded commas
      function parseCSVLine(line) {
        const result = [];
        let current = '';
        let inQuotes = false;

        for (let i = 0; i < line.length; i++) {
          const char = line[i];
          if (char === '"') {
            inQuotes = !inQuotes;
          } else if (char === ',' && !inQuotes) {
            result.push(current.trim().replace(/^"|"$/g, ''));
            current = '';
          } else {
            current += char;
          }
        }
        result.push(current.trim().replace(/^"|"$/g, ''));
        return result;
      }

      careerPrompts = lines.filter(line => line.trim()).map(line => {
        const [prompt, completion, labels] = parseCSVLine(line);
        return { prompt, completion, labels };
      });

      // Load PS101 framework questions
      const ps101Response = await fetch('./data/prompts.ps101.json');
      const ps101Data = await ps101Response.json();
      ps101Framework = ps101Data.prompts;

      console.log(`Loaded ${careerPrompts.length} career coaching prompts + ${ps101Framework.length} PS101 framework questions`);
    } catch (error) {
      console.error('Failed to load prompt systems:', error);
    }
  }

// Smart prompt matching
const MATCH_THRESHOLD = 3;
const STOP_WORDS = new Set([
  'i','me','my','mine','myself','am','is','are','was','were','be','been','being',
  'the','a','an','and','or','but','if','then','than','that','this','these','those',
  'for','from','with','about','into','onto','over','under','between','among','of',
  'at','by','on','in','out','up','down','off','to','as','it','its','they','them',
  'their','theirs','we','us','our','ours','you','your','yours','do','does','did',
  'done','so','not','no','yes','can','could','should','would','will','just',
  'get','gets','getting','got','how','make','makes','making','take','takes','taking',
  'feel','feels','feeling','really','also','still','ever','even','again'
]);

function tokenize(text) {
  return text
    .toLowerCase()
    .replace(/[^a-z0-9\s]/g, ' ')
    .split(/\s+/)
    .filter(word => word && word.length > 2 && !STOP_WORDS.has(word));
}

function findBestMatch(userInput) {
  if (!careerPrompts.length) return null;

  const inputTokens = tokenize(userInput);
  if (!inputTokens.length) return null;
  const inputSet = new Set(inputTokens);

  let bestMatch = null;
  let highestScore = 0;

  careerPrompts.forEach(prompt => {
    const promptTokens = tokenize(prompt.prompt);
    if (!promptTokens.length) return;
    const promptSet = new Set(promptTokens);

    let overlap = 0;
    inputSet.forEach(token => {
      if (promptSet.has(token)) overlap += 1;
    });

    if (overlap > highestScore) {
      highestScore = overlap;
      bestMatch = { ...prompt, score: overlap };
    }
  });

  if (!bestMatch || highestScore < MATCH_THRESHOLD) {
    return null;
  }

  return bestMatch;
}

  // Safe footer year update with null-guard
  const yearEl = $('#y');
  if (yearEl) yearEl.textContent = new Date().getFullYear();

  // Initialize prompts on page load
  loadPrompts();

  // API Status Check with improved error handling
  async function checkAPI() {
    try {
      const response = await fetch(`${API_BASE}/health`, {
        method: 'GET',
        timeout: 5000
      });
      if (response.ok) {
        const data = await response.json();
        if (data.ok) {
          $('#apiStatus').textContent = 'ready';
          $('#apiStatus').className = 'status working';
          return true;
        }
      }
      throw new Error('API not responding');
    } catch (error) {
      $('#apiStatus').textContent = 'offline';
      $('#apiStatus').className = 'status error';
      console.warn('API check failed:', error.message);
      return false;
    }
  }

  // API check and chat listeners moved to initApp Phase 2.5
  // (prevents DOM access before elements exist)

// Chat element references - will be set in initApp
let chat = document.getElementById('chat');
let chatLog = document.getElementById('chatLog');
let sendMsg = document.getElementById('sendMsg');
let chatInput = document.getElementById('chatInput');

const ensureChatRefs = () => {
  chat = chat || document.getElementById('chat');
  chatLog = chatLog || document.getElementById('chatLog');
  sendMsg = sendMsg || document.getElementById('sendMsg');
  chatInput = chatInput || document.getElementById('chatInput');
};

const chatGuard = (context, requireInput = false) => {
  ensureChatRefs();
  const ready = chat && chatLog && (!requireInput || chatInput);
  if (ready) {
    return true;
  }
  console.warn(`[CHAT] ${context} called before chat widgets ready`, {
    chatReady: !!chat,
    chatLogReady: !!chatLog,
    chatInputReady: !!chatInput
  });
  return false;
};

  function addMsg(txt, who = 'you') {
    if (!chatGuard('addMsg')) {
      return;
    }
    const div = document.createElement('div');
    div.className = `msg ${who}`;
    div.textContent = (who === 'you' ? '> ' : '') + txt;
    chatLog.appendChild(div);
    chatLog.scrollTop = chatLog.scrollHeight;

    // Announce new messages to screen readers
    if (who === 'bot') {
      div.setAttribute('aria-live', 'polite');
    }
  }

async function askCoach(prompt) {
  const controller = new AbortController();
  const timeoutId = setTimeout(() => controller.abort(), 15000); // 15s timeout
  try {
    const payload = { prompt: prompt.trim() };
    const data = await callJson('/wimd', {
      method: 'POST',
      body: payload,
      signal: controller.signal
    });
    const message = data?.result?.message ?? data?.result ?? data?.message ?? '';
    return typeof message === 'string' ? message.trim() : '';
  } catch (error) {
    if (error.name === 'AbortError') {
      return 'request timed out - please try again';
    }
    console.error('Coach API error:', error);
    return `connection issue (${error.message || 'unknown error'})`;
  } finally {
    clearTimeout(timeoutId);
  }
}

  async function send() {
    if (!chatGuard('send', true)) {
      return;
    }
    const v = chatInput.value.trim();
    if (!v) return;

    addMsg(v, 'you');
    chatInput.value = '';

    // Show loading with better UX
    const loadingDiv = document.createElement('div');
    loadingDiv.className = 'msg loading';
    loadingDiv.textContent = 'thinking...';
    chatLog.appendChild(loadingDiv);
    chatLog.scrollTop = chatLog.scrollHeight;

  try {
    const response = await askCoach(v);
    loadingDiv.remove();
    const answer = (response || '').trim();
    if (answer) {
      addMsg(answer, 'bot');
    } else {
      addMsg('no response from coach yet ‚Äî please try asking in a different way.', 'bot');
    }
  } catch (error) {
    loadingDiv.remove();
    addMsg('connection issue - please try again', 'bot');
  }

    softRoute(v);
  }

  // chatInput Enter key listener moved to initApp Phase 2.5

  // Enhanced Coach Strip (immediate input)
  let coachAskEl = document.getElementById('coachAsk');
  let coachSendEl = document.getElementById('coachSend');

  const ensureCoachStripRefs = () => {
    if (!coachAskEl) {
      coachAskEl = document.getElementById('coachAsk');
    }
    if (!coachSendEl) {
      coachSendEl = document.getElementById('coachSend');
    }
    return { coachAskEl, coachSendEl };
  };

  async function sendStrip() {
    ensureCoachStripRefs();
    if (!coachAskEl) {
      console.warn('[COACH] sendStrip called before coachAsk ready');
      return;
    }
    const v = (coachAskEl.value || '').trim();
    if (!v) return;
    if (!chatGuard('sendStrip')) {
      return;
    }
    chat.style.display = 'block';
    addMsg(v, 'you');
    coachAskEl.value = '';

    // Show loading
    const loadingDiv = document.createElement('div');
    loadingDiv.className = 'msg loading';
    loadingDiv.textContent = 'thinking...';
    chatLog.appendChild(loadingDiv);
    chatLog.scrollTop = chatLog.scrollHeight;

    // Try local CSV prompts first (607 career coaching responses)
  const match = findBestMatch(v);
  const hasStrongMatch = match && match.score >= MATCH_THRESHOLD;
  if (hasStrongMatch) {
    console.log('[COACH] Using knowledge base match', {
      score: match.score,
      prompt: match.prompt?.slice(0, 80) || ''
    });
    addMsg(match.completion, 'bot');
    loadingDiv.textContent = 'bringing in fresh insights...';
  }

  try {
    const response = await askCoach(v);
    loadingDiv.remove();
    const answer = (response || '').trim();
    if (answer) {
      addMsg(answer, 'bot');
    } else {
      if (!hasStrongMatch) {
        addMsg('no response from coach yet ‚Äî please try asking in a different way.', 'bot');
      }
    }
  } catch (error) {
    loadingDiv.remove();
    if (!hasStrongMatch) {
      addMsg('I understand you\'re looking for guidance. Could you try rephrasing your question? I work best with specific situations like "I feel stuck in my career" or "I don\'t know what I want to do."', 'bot');
    } else {
      addMsg('having trouble reaching the live coach ‚Äî I\'ll keep listening for now.', 'bot');
    }
  }

    softRoute(v);
  }

  // coachSend and coachAsk listeners moved to initApp Phase 2.5
  // (prevents calling sendStrip before chat variables are initialized)

  // Enhanced Upload with Real API Integration
  const modal = $('#uploadModal');
  const dropZone = $('#dropZone');
  const filePick = $('#filePick');
  const uploadStatus = $('#uploadStatus');

  document.querySelectorAll('[data-action=\"open-upload\"]').forEach(link => {
    link.addEventListener('click', e => {
      e.preventDefault();
      modal.style.display = 'flex';
      document.body.style.overflow = 'hidden';
    });
  });

  $('#closeUpload').addEventListener('click', closeUploadModal);

  function closeUploadModal() {
    modal.style.display = 'none';
    document.body.style.overflow = 'auto';
    uploadStatus.style.display = 'none';
  }

  // Close modal on Escape key
  document.addEventListener('keydown', e => {
    if (e.key === 'Escape' && modal.style.display === 'flex') {
      closeUploadModal();
    }
  });

  // Enhanced file upload functionality
  async function uploadFile(file) {
    if (!file) return;

    // Validate file size (10MB limit)
    if (file.size > 10 * 1024 * 1024) {
      uploadStatus.style.display = 'block';
      uploadStatus.innerHTML = '<div style="font-size:11px;color:#d63638">file too large (max 10MB)</div>';
      return;
    }

    try {
      uploadStatus.style.display = 'block';
      uploadStatus.innerHTML = '<div style="font-size:11px;color:var(--muted)">uploading ' + file.name + '...</div>';

      const formData = new FormData();
      formData.append('file', file);
      formData.append('prompt', 'Please analyze this file and provide career coaching insights.');

      const response = await fetch(`${API_BASE}/wimd/upload`, {
        method: 'POST',
        body: formData
      });

      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }

      const result = await response.json();

      uploadStatus.innerHTML = '<div style="font-size:11px;color:#2d6e2d">upload complete!</div>';

      // Add result to chat
      chat.style.display = 'block';
      addMsg(`uploaded: ${file.name}`, 'you');
      addMsg(result?.result?.message || result?.result || 'file processed', 'bot');

      // Close modal after delay
      setTimeout(() => {
        closeUploadModal();
      }, 2000);

    } catch (error) {
      uploadStatus.innerHTML = '<div style="font-size:11px;color:#d63638">upload failed: ' + (error.message || 'unknown error') + '</div>';
      console.error('Upload error:', error);
    }
  }

  filePick.addEventListener('change', async (e) => {
    const files = e.target.files;
    if (!files || files.length === 0) return;

    for (let file of files) {
      await uploadFile(file);
    }
  });

  // Enhanced drag and drop
  dropZone.addEventListener('dragover', e => {
    e.preventDefault();
    dropZone.style.background = '#f8f8f8';
    dropZone.style.borderColor = '#999';
  });

  dropZone.addEventListener('dragleave', (e) => {
    // Only reset if actually leaving the drop zone
    if (!dropZone.contains(e.relatedTarget)) {
      dropZone.style.background = '';
      dropZone.style.borderColor = '';
    }
  });

  dropZone.addEventListener('drop', async (e) => {
    e.preventDefault();
    dropZone.style.background = '';
    dropZone.style.borderColor = '';

    const files = e.dataTransfer.files;
    for (let file of files) {
      await uploadFile(file);
    }
  });

  // Enhanced Job Search Integration
  $('#findJobs').addEventListener('click', async (e) => {
    e.preventDefault();

    const jobsText = $('#t_jobs').value.trim();
    const query = jobsText || 'career opportunities';

    chat.style.display = 'block';
    addMsg(`finding jobs: ${query}`, 'you');

    const loadingDiv = document.createElement('div');
    loadingDiv.className = 'msg loading';
    loadingDiv.textContent = 'searching...';
    chatLog.appendChild(loadingDiv);
    chatLog.scrollTop = chatLog.scrollHeight;

    try {
      const response = await fetch(`${API_BASE}/jobsearch`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          query: query,
          location: 'Toronto, ON',
          max_results: 5
        })
      });

      loadingDiv.remove();

      if (!response.ok) {
        throw new Error(`HTTP ${response.status}`);
      }

      const result = await response.json();
      const jobsFound = result?.results?.length || 0;
      addMsg(`found ${jobsFound} opportunities. check your dashboard module for details.`, 'bot');

    } catch (error) {
      loadingDiv.remove();
      addMsg('job search temporarily unavailable', 'bot');
      console.error('Job search error:', error);
    }
  });

  // Enhanced Save / Load + Feedback + Leave Guard
  let dirty = false, savedThisSession = false;

  function markDirty() {
    dirty = true;
    $('#saveNotice').style.display = 'flex';
  }

  const METRIC_TARGETS = [
    { id: 'mClarity', key: 'clarity' },
    { id: 'mAction', key: 'action' },
    { id: 'mMomentum', key: 'momentum' }
  ];

  function formatMetricValue(value) {
    if (value === null || value === undefined) {
      return { display: '‚Äî', stored: '' };
    }
    const cleaned = typeof value === 'string' ? parseFloat(value.replace('%', '').trim()) : Number(value);
    if (!Number.isFinite(cleaned)) {
      return { display: '‚Äî', stored: '' };
    }
    const clamped = Math.max(0, Math.min(100, Math.round(cleaned)));
    if (clamped === 0) {
      return { display: '‚Äî', stored: '' };
    }
    return { display: `${clamped}%`, stored: String(clamped) };
  }

  function renderMetrics(metrics) {
    let anyValue = false;
    METRIC_TARGETS.forEach(({ id, key }) => {
      const el = document.getElementById(id);
      if (!el) return;
      const { display, stored } = formatMetricValue(metrics ? metrics[key] : undefined);
      el.textContent = display;
      if (stored) {
        el.dataset.value = stored;
        anyValue = true;
      } else {
        delete el.dataset.value;
      }
    });

    const metricsSection = document.getElementById('metricsSection');
    const metricsNote = document.getElementById('metricsNote');
    if (metricsSection) {
      metricsSection.classList.toggle('has-data', anyValue);
    }
    if (metricsNote) {
      metricsNote.style.display = anyValue ? 'none' : '';
    }
  }

  renderMetrics(null);

  function collect() {
    const metricValue = (id) => {
      const el = document.getElementById(id);
      return el?.dataset.value || '';
    };
    return {
      version: '2.0',
      timestamp: new Date().toISOString(),
      userAgent: navigator.userAgent,
      metrics: {
        clarity: metricValue('mClarity'),
        action: metricValue('mAction'),
        momentum: metricValue('mMomentum')
      },
      notes: {
        ps101: $('#t_ps101').value,
        coaching: $('#t_coaching').value,
        jobs: $('#t_jobs').value,
        resume: $('#t_resume').value,
        dashboard: $('#t_dashboard').value
      },
      feedback: collectFeedback()
    };
  }

  function collectFeedback() {
    const val = n => {
      const el = [...document.getElementsByName(n)].find(i => i.checked);
      return el ? el.value : '';
    };
    return {
      clarity: val('fb_clarity'),
      welcome: val('fb_welcome'),
      path: val('fb_path'),
      comment: $('#fb_comment').value
    };
  }

  function apply(data) {
    if (data?.metrics) {
      renderMetrics(data.metrics);
    } else {
      renderMetrics(null);
    }
    if (data?.notes) {
      $('#t_ps101').value = data.notes.ps101 || '';
      $('#t_coaching').value = data.notes.coaching || '';
      $('#t_jobs').value = data.notes.jobs || '';
      $('#t_resume').value = data.notes.resume || '';
      $('#t_dashboard').value = data.notes.dashboard || '';
    }
    if (data?.feedback) {
      const set = (name, val) => {
        if (!val) return;
        const el = [...document.getElementsByName(name)].find(i => i.value === val);
        if (el) el.checked = true;
      };
      set('fb_clarity', data.feedback.clarity);
      set('fb_welcome', data.feedback.welcome);
      set('fb_path', data.feedback.path);
      $('#fb_comment').value = data.feedback.comment || '';
    }
  }

  function download(filename, obj) {
    try {
      const blob = new Blob([JSON.stringify(obj, null, 2)], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(a.href);
      savedThisSession = true;
      $('#saveNotice').style.display = 'none';
      dirty = false;
    } catch (error) {
      console.error('Download failed:', error);
      alert('Save failed - please try again');
    }
  }

  $('#saveBtn').addEventListener('click', () => download('delta-progress.json', collect()));

  $('#loadFile').addEventListener('change', (e) => {
    const f = e.target.files[0];
    if (!f) return;
    const r = new FileReader();
    r.onload = () => {
      try {
        const data = JSON.parse(r.result);
        apply(data);
        alert('Progress loaded successfully');
      } catch (err) {
        alert('Invalid file format');
      }
    };
    r.onerror = () => alert('Failed to read file');
    r.readAsText(f);
  });

  // Enhanced auto-save and form tracking
  const formSelectors = ['#t_ps101', '#t_coaching', '#t_jobs', '#t_resume', '#t_dashboard', '#fb_comment'];
  formSelectors.forEach(sel => {
    const el = $(sel);
    if (el) {
      el.addEventListener('input', () => {
        markDirty();
        debounce(saveAuto, 1000)();
      });
    }
  });

  ['fb_clarity', 'fb_welcome', 'fb_path'].forEach(name => {
    document.getElementsByName(name).forEach(el =>
      el.addEventListener('change', () => {
        markDirty();
        debounce(saveAuto, 1000)();
      })
    );
  });

  // Debounce function for auto-save
  function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  }

  const AUTO = 'delta_auto_v3';
  function saveAuto() {
    try {
      localStorage.setItem(AUTO, JSON.stringify(collect()));
    } catch (error) {
      console.warn('Auto-save failed:', error);
    }
  }

  (function loadAuto() {
    try {
      const data = JSON.parse(localStorage.getItem(AUTO) || '{}');
      if (Object.keys(data).length && data.version) {
        apply(data);
      }
    } catch (e) {
      console.warn('Auto-load failed:', e);
    }
  })();

  window.addEventListener('beforeunload', (e) => {
    if (dirty && !savedThisSession) {
      e.preventDefault();
      e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
    }
  });

  $('#noticeSave').addEventListener('click', () => download('delta-progress.json', collect()));
  $('#noticeDismiss').addEventListener('click', () => {
    $('#saveNotice').style.display = 'none';
    dirty = false;
  });

  // Enhanced feedback submission
  $('#fbSubmit').addEventListener('click', () => {
    try {
      const payload = {
        version: '2.0',
        timestamp: new Date().toISOString(),
        feedback: collectFeedback(),
        userAgent: navigator.userAgent
      };
      download('delta-feedback.json', payload);
      alert('Feedback saved! Thank you for helping us improve.');
    } catch (error) {
      console.error('Feedback submission failed:', error);
      alert('Failed to save feedback - please try again');
    }
  });

  // Enhanced smooth anchors + soft routing
  function smoothTo(id) {
    const el = $(id);
    if (el) {
      el.scrollIntoView({ behavior: 'smooth', block: 'start' });
      // Focus management for accessibility
      if (el.tabIndex < 0) el.tabIndex = -1;
      el.focus();
    }
  }

  document.querySelectorAll('a[href^="#"]').forEach(a => {
    a.addEventListener('click', evt => {
      const href = a.getAttribute('href');
      if (href && href.length > 1) {
        evt.preventDefault();
        smoothTo(href);
      }
    });
  });

  console.log('[IIFE] Reached helper functions section');

  // Authentication helper functions
  function setStatus(el, msg, kind='info'){
    if(!el) return;
    el.textContent = msg || '';
    el.classList.remove('error','ok');
    if(!msg) return;
    if(kind === 'error') el.classList.add('error');
    else if(kind === 'ok') el.classList.add('ok');
  }

  function setSession(id){
    if(!id) return;
    sessionId = id;
    localStorage.setItem(SESSION_KEY, id);
    document.body.dataset.session = id;
    startAutoSave();
  }

  function saveUserData(data){
    userData = {...userData, ...data};
    localStorage.setItem(USER_DATA_KEY, JSON.stringify(userData));
  }

  function startAutoSave(){
    if(autoSaveInterval) clearInterval(autoSaveInterval);
    autoSaveInterval = setInterval(() => {
      if(sessionId && userData){
        saveUserData({
          lastActivity: new Date().toISOString(),
          sessionId: sessionId
        });
      }
    }, 30000);
  }

  function stopAutoSave(){
    if(autoSaveInterval) {
      clearInterval(autoSaveInterval);
      autoSaveInterval = null;
    }
  }

  async function ensureConfig(){
    if(apiBase) return apiBase;
    if(configPromise) return configPromise;
    const endpoints = [
      `${window.location.origin}/config`,
      'https://mosaic-backend-tpog.onrender.com/config',
      'https://whatismydelta.com/config'
    ];
    configPromise = (async ()=>{
      for(const url of endpoints){
        try{
          const res = await fetch(url, {mode:'cors'});
          if(!res.ok) continue;
          const data = await res.json();
          apiBase = (data.apiBase || new URL(url).origin || '').replace(/\/$/,'');
          if(!apiBase) apiBase = new URL(url).origin;
          document.body.dataset.apiBase = apiBase;
          return apiBase;
        }catch(err){
          // ignore endpoint failure
        }
      }
      apiBase = 'https://mosaic-backend-tpog.onrender.com';
      document.body.dataset.apiBase = apiBase;
      return apiBase;
    })();
    return configPromise;
  }

  async function callJson(path, {method='GET', body, headers={}, signal} = {}){
    await ensureConfig();
    const init = {method, headers:{...headers}};
    if (signal) {
      init.signal = signal;
    }
    if(body !== undefined){
      if(body instanceof FormData){
        init.body = body;
      }else{
        init.headers['Content-Type'] = 'application/json';
        init.body = JSON.stringify(body);
      }
    }
    if(sessionId){
      init.headers['X-Session-ID'] = sessionId;
    }
    const res = await fetch(`${apiBase}${path}`, init);
    let data = null;
    try{ data = await res.json(); } catch(err){ data = null; }
    if(!res.ok){
      const message = (data && (data.detail || data.error)) || `request_failed (${res.status})`;
      throw new Error(message);
    }
    if(data && data.session_id) setSession(data.session_id);
    if(data && data.metrics) {
      renderMetrics(data.metrics);
    }
    return data || {};
  }

  async function authenticateUser(email, password, isRegister = false, discountCode = null){
    try{
      setStatus($('#authStatus'), 'authenticating...');

      if(isRegister){
        if(password.length < 6){
          throw new Error('Password must be at least 6 characters');
        }
        if(!email.includes('@')){
          throw new Error('Please enter a valid email address');
        }

        const body = { email, password };
        if(discountCode) body.discount_code = discountCode;

        const response = await callJson('/auth/register', {
          method: 'POST',
          body
        });

        currentUser = {
          id: response.user_id,
          email: response.email,
          createdAt: response.created_at,
          lastLogin: response.last_login,
          subscriptionTier: response.subscription_tier,
          subscriptionStatus: response.subscription_status
        };

        const tierMessage = response.subscription_tier === 'beta' ? ' (beta access granted)' : '';
        setStatus($('#authStatus'), `account created successfully!${tierMessage}`, 'ok');

      } else {
        const response = await callJson('/auth/login', {
          method: 'POST',
          body: { email, password }
        });

        currentUser = {
          id: response.user_id,
          email: response.email,
          createdAt: response.created_at,
          lastLogin: response.last_login
        };

        setStatus($('#authStatus'), 'welcome back!', 'ok');
      }

      isAuthenticated = true;
      localStorage.removeItem(TRIAL_START_KEY);
      trialStartTime = null;
      saveUserData({
        user: currentUser,
        authenticated: true,
        loginTime: new Date().toISOString()
      });

      $('#authModal').style.display = 'none';
      const welcome = $('#welcome');
      if(welcome) welcome.hidden = false;
      const logoutBtn = $('#logoutBtn');
      if(logoutBtn) logoutBtn.hidden = false;
      updateUserProgress();
      startAutoSave();
      if (typeof window.__updateAuthCTAVisibility === 'function') {
        window.__updateAuthCTAVisibility();
      }

    }catch(err){
      setStatus($('#authStatus'), err.message, 'error');
      // Hide modal on error to prevent it from covering the UI
      $('#authModal').style.display = 'none';
    }
  }

  function updateUserProgress(){
    if(currentUser){
      const sessionDisplay = $('#sessionDisplay');
      const pathDisplay = $('#pathDisplay');
      const lastActivityDisplay = $('#lastActivityDisplay');
      const userProgress = $('#userProgress');

      if(sessionDisplay) sessionDisplay.textContent = currentUser.email;
      if(pathDisplay) pathDisplay.textContent = userData.path || '-';
      if(lastActivityDisplay) lastActivityDisplay.textContent = userData.lastActivity ? new Date(userData.lastActivity).toLocaleString() : '-';
      if(userProgress) userProgress.hidden = false;
    }
  }

  async function logout(){
    console.log('[LOGOUT] Starting logout process...');
    const oldSessionId = sessionId;
    console.log('[LOGOUT] Session ID:', oldSessionId);
    sessionStorage.setItem('LOGGING_OUT', '1');
    console.log('[LOGOUT] Set LOGGING_OUT flag in sessionStorage');
    localStorage.clear();
    console.log('[LOGOUT] Cleared localStorage');
    try {
      await callJson('/auth/logout', {
        method: 'POST',
        headers: oldSessionId ? { 'X-Session-ID': oldSessionId } : {}
      });
      console.log('[LOGOUT] Backend logout API called successfully');
    } catch(err) {
      console.error('[LOGOUT] Logout API error:', err);
    }
    console.log('[LOGOUT] Reloading page...');
    window.location.reload();
  }

  function hideAuthModal(){
    const authModal = $('#authModal');
    if(authModal){
      authModal.style.display = 'none';
    }
  }

  function scheduleTrialExpiry(){
    if(isAuthenticated || !trialStartTime) return;
    const elapsed = Date.now() - parseInt(trialStartTime, 10);
    const remaining = TRIAL_DURATION - elapsed;
    if(remaining > 0){
      setTimeout(checkTrialExpired, remaining);
    }else{
      checkTrialExpired();
    }
  }

  function startTrial(){
    if(!isAuthenticated && !trialStartTime){
      trialStartTime = Date.now().toString();
      localStorage.setItem(TRIAL_START_KEY, trialStartTime);
      scheduleTrialExpiry();
    }
  }

  function checkTrialExpired(){
    if(isAuthenticated) return;
    const elapsed = Date.now() - parseInt(trialStartTime);
    if(elapsed >= TRIAL_DURATION){
      showSignUpPrompt();
    }
  }

  function showSignUpPrompt(){
    const authModal = $('#authModal');
    if(authModal){
      authModal.style.display = 'block';
      const authStatus = $('#authStatus');
      if(authStatus){
        setStatus(authStatus, 'trial period ended - sign up to continue', 'info');
      }
    }
  }

  // Safe localStorage helper with defensive error handling
  function safeLocalStorageGet(key, defaultValue = '') {
    try {
      const value = localStorage.getItem(key);
      return value !== null ? value : defaultValue;
    } catch (error) {
      console.warn(`[STORAGE] Failed to read ${key}:`, error);
      return defaultValue;
    }
  }

  function safeLocalStorageSet(key, value) {
    try {
      localStorage.setItem(key, value);
      return true;
    } catch (error) {
      console.warn(`[STORAGE] Failed to write ${key}:`, error);
      return false;
    }
  }

  console.log('[IIFE] About to define initApp');

  // Consolidated application initializer
  function initApp() {
    try {
      console.log('[INIT] Starting application initialization...');

      // Phase 1: Trial/Auth Initialization
      console.log('[INIT] Phase 1: Initializing auth/trial mode...');
      const currentSessionId = safeLocalStorageGet(SESSION_KEY, '');
      const currentTrialStart = safeLocalStorageGet(TRIAL_START_KEY);

      console.log('[INIT] sessionId:', currentSessionId ? 'exists' : 'none');
      console.log('[INIT] trialStartTime:', currentTrialStart || 'none');

      if(currentSessionId){
        console.log('[INIT] User has session - ensuring access');
        sessionId = currentSessionId;
      }else{
        if(!currentTrialStart){
          console.log('[INIT] New visitor - starting trial');
          startTrial();
        }else{
          trialStartTime = currentTrialStart;
          scheduleTrialExpiry();
          const elapsed = Date.now() - parseInt(currentTrialStart, 10);
          console.log('[INIT] Existing trial - elapsed:', Math.floor(elapsed/1000), 'seconds');
          if(elapsed < TRIAL_DURATION){
            console.log('[INIT] Trial still valid');
          }else{
            console.log('[INIT] Trial expired - showing modal');
            checkTrialExpired();
          }
        }
      }
      console.log('[INIT] Phase 1 complete');

      // Phase 2: UI Visibility Setup
      console.log('[INIT] Phase 2: Setting up UI visibility...');
      const feedbackSection = document.getElementById('feedback');
      if (feedbackSection) {
        feedbackSection.style.display = 'block';
        feedbackSection.style.visibility = 'visible';
      }
      console.log('[INIT] Phase 2 complete');

      // Phase 2.5: Initialize API check and chat system
      console.log('[INIT] Phase 2.5: Initializing API check and chat...');

      // API Status Check
      checkAPI();
      // Retry API check every 30 seconds if offline
      setInterval(() => {
        const apiStatus = $('#apiStatus');
        if (apiStatus && apiStatus.className.includes('error')) {
          checkAPI();
        }
      }, 30000);

  // Chat System Setup
  chat = $('#chat'); // Set module-level variable
  chatInput = $('#chatInput'); // Set module-level variable
  chatLog = $('#chatLog'); // Set module-level variable
  sendMsg = $('#sendMsg'); // Set module-level variable
  ensureCoachStripRefs();
  console.log('[INIT] Phase 2.5 chat readiness', {
    chatReady: !!chat,
    chatLogReady: !!chatLog,
    chatInputReady: !!chatInput,
    sendMsgReady: !!sendMsg,
    coachAskReady: !!coachAskEl,
    coachSendReady: !!coachSendEl
  });
      const openChatBtn = $('#openChat');
      const closeChatBtn = $('#closeChat');

      if (openChatBtn && chat && chatInput) {
        openChatBtn.addEventListener('click', e => {
          e.preventDefault();
          chat.style.display = 'block';
          chatInput.focus();
        });
      }

      if (closeChatBtn && chat) {
        closeChatBtn.addEventListener('click', () => {
          chat.style.display = 'none';
        });
      }

      // Close chat on Escape key
  document.addEventListener('keydown', e => {
    if (chat && e.key === 'Escape' && chat.style.display === 'block') {
      chat.style.display = 'none';
    }
  });

  // First-visit gentle nudge with improved UX (runs after chat wiring)
  const SEEN = 'delta_seen_intro_v2';
  if (chat && chatLog && !localStorage.getItem(SEEN)) {
    setTimeout(() => {
      if (!chatGuard('first-visit nudge')) {
        return;
      }
      chat.style.display = 'block';
      addMsg('hi ‚Äî want to start with some key questions or explore on your own?', 'bot');
      localStorage.setItem(SEEN, '1');
    }, 1000);
  }

      // Setup send message handlers
      if (sendMsg) {
        sendMsg.addEventListener('click', send);
      }

      if (chatInput) {
        chatInput.addEventListener('keydown', e => {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            send();
          }
        });
      }

      // Setup coach strip (ask field) event listeners
      console.log('[INIT] Phase 2.5 coach strip setup', {
        coachSendReady: !!coachSendEl,
        coachAskReady: !!coachAskEl
      });

      if (coachSendEl) {
        coachSendEl.addEventListener('click', (e) => {
          e.preventDefault();
          console.log('[COACH] coachSend clicked');
          sendStrip();
        });
      } else {
        console.warn('[INIT] coachSend element not found');
      }

      if (coachAskEl) {
        coachAskEl.addEventListener('keydown', e => {
          if (e.key === 'Enter') {
            e.preventDefault();
            console.log('[COACH] coachAsk Enter pressed');
            sendStrip();
          }
        });
      } else {
        console.warn('[INIT] coachAsk element not found');
      }

      console.log('[INIT] Phase 2.5 complete');

      // Phase 3: Data-coach fixes and link handlers
      console.log('[INIT] Phase 3: Setting up navigation and link handlers...');
      const coachElements = document.querySelectorAll('[data-coach]');
      coachElements.forEach(el => {
        const prompt = el.dataset.coach;
        el.dataset.prompt = prompt;
        delete el.dataset.coach;
      });

      // Fix data-prompt link handlers
      document.querySelectorAll('[data-prompt]').forEach(link => {
        link.addEventListener('click', async (e) => {
          e.preventDefault();
          const prompt = link.dataset.prompt;
          if (!prompt) return;
          const { coachAskEl: askEl, coachSendEl: sendEl } = ensureCoachStripRefs();
          if (askEl) {
            askEl.value = prompt;
          }
          if (sendEl) {
            sendStrip();
          }
        });
      });

      // Fix resource section internal links
      const resourceLinks = document.querySelectorAll('#resources a[href^="#"]');
      resourceLinks.forEach(link => {
        link.addEventListener('click', (e) => {
          e.preventDefault();
          const targetId = link.getAttribute('href').substring(1);
          const targetSection = document.getElementById(targetId);
          if (targetSection) {
            targetSection.scrollIntoView({ behavior: 'smooth' });
          }
        });
      });

      // Obfuscate email address to prevent spam bots
      const emailSpan = document.getElementById('emailContact');
      if (emailSpan) {
        const parts = ['hello', 'whatismydelta', 'com'];
        const email = parts[0] + '@' + parts[1] + '.' + parts[2];
        emailSpan.innerHTML = `<a href="mailto:${email}">${email}</a>`;
      }

      // Handle contact form submission
      const contactForm = document.getElementById('contactForm');
      if (contactForm) {
        contactForm.addEventListener('submit', async (e) => {
          e.preventDefault();

          const statusSpan = document.getElementById('contactStatus');
          const submitBtn = contactForm.querySelector('button[type="submit"]');

          const formData = {
            name: document.getElementById('contactName').value,
            email: document.getElementById('contactEmail').value,
            subject: document.getElementById('contactSubject').value,
            message: document.getElementById('contactMessage').value,
            timestamp: new Date().toISOString(),
            userAgent: navigator.userAgent,
            bcc: 'damianseguin@gmail.com'
          };

          submitBtn.disabled = true;
          submitBtn.textContent = 'Sending...';
          statusSpan.textContent = 'Sending message...';
          statusSpan.style.color = 'var(--muted)';

          try {
            const response = await fetch('/', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
              },
              body: new URLSearchParams({
                'form-name': 'contact',
                ...formData
              })
            });

            if (response.ok) {
              statusSpan.textContent = 'Message sent successfully!';
              statusSpan.style.color = 'green';
              contactForm.reset();
            } else {
              throw new Error('Network response was not ok');
            }
          } catch (error) {
            console.error('Contact form error:', error);
            statusSpan.textContent = 'Error sending message. Please try the email link above.';
            statusSpan.style.color = 'red';
          } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Send Message';

            setTimeout(() => {
              statusSpan.textContent = '';
            }, 5000);
          }
        });
      }

      // Voice input functionality
      const voiceBtn = document.getElementById('voiceBtn');

      if (voiceBtn && 'webkitSpeechRecognition' in window) {
        ensureCoachStripRefs();
        if (!coachAskEl) {
          console.warn('[COACH] Voice input unavailable ‚Äî coachAsk not ready');
        } else {
          const recognition = new webkitSpeechRecognition();
          recognition.continuous = false;
          recognition.interimResults = false;
          recognition.lang = 'en-US';

          let isListening = false;

          voiceBtn.addEventListener('click', () => {
            if (isListening) {
              recognition.stop();
              return;
            }

            recognition.start();
            isListening = true;
            voiceBtn.textContent = '‚èπÔ∏è';
            voiceBtn.title = 'Stop recording';
            coachAskEl.placeholder = 'Listening...';
          });

          recognition.onresult = (event) => {
            const transcript = event.results[0][0].transcript;
            coachAskEl.value = transcript;

            setTimeout(() => {
              sendStrip();
            }, 500);
          };

          recognition.onend = () => {
            isListening = false;
            voiceBtn.textContent = 'üé§';
            voiceBtn.title = 'Voice input';
            coachAskEl.placeholder = 'type a question or try: help me get started';
          };

          recognition.onerror = (event) => {
            console.warn('Speech recognition error:', event.error);
            isListening = false;
            voiceBtn.textContent = 'üé§';
            voiceBtn.title = 'Voice input';
            coachAskEl.placeholder = 'type a question or try: help me get started';
          };
        }
      } else if (voiceBtn) {
        voiceBtn.style.display = 'none';
      }
      console.log('[INIT] Phase 3 complete');

      // Phase 4: Auth Modal Button Setup
      console.log('[INIT] Phase 4: Setting up auth modal button...');
      const showAuthModalBtn = $('#showAuthModal');
      const floatingAuthBtn = $('#floatingAuthBtn');
      const openAuthModal = (e) => {
        e?.preventDefault();
        const authModal = $('#authModal');
        if (authModal) {
          authModal.style.display = 'block';
        }
      };

      const updateAuthCTAVisibility = () => {
        if (showAuthModalBtn) {
          showAuthModalBtn.style.display = isAuthenticated ? 'none' : 'inline-block';
        }
        if (floatingAuthBtn) {
          floatingAuthBtn.style.display = isAuthenticated ? 'none' : 'inline-flex';
        }
      };

      if (showAuthModalBtn) {
        showAuthModalBtn.removeEventListener('click', openAuthModal);
        showAuthModalBtn.addEventListener('click', openAuthModal);
      }
      if (floatingAuthBtn) {
        floatingAuthBtn.removeEventListener('click', openAuthModal);
        floatingAuthBtn.addEventListener('click', openAuthModal);
      }

      updateAuthCTAVisibility();
      window.__updateAuthCTAVisibility = updateAuthCTAVisibility;
      console.log('[INIT] Phase 4 complete');

      // Phase 5: PS101 Event Listeners (deferred to end of function)
      console.log('[INIT] Phase 5: Setting up PS101 event listeners...');
      initPS101EventListeners();
      console.log('[INIT] Phase 5 complete');

      console.log('[INIT] Application initialization complete');
    } catch(error) {
      console.error('[INIT] Initialization error:', error);
      console.log('[INIT] Falling back to open access');
    }
  }

  function validateCurrentStep() {
      const state = PS101State;
      const step = state.getCurrentStep();
      const textarea = document.getElementById('step-answer');
      if (!textarea || !step) return false;

      const answer = textarea.value.trim();
      const promptIndex = state.currentPromptIndex || 0;
      const totalPrompts = (step.prompts && step.prompts.length) ? step.prompts.length : 1;
      const isLastPrompt = promptIndex === totalPrompts - 1;

      // For experiment steps (6-9) on last prompt, skip textarea validation
      // These steps use experiment components instead of textarea
      if (isLastPrompt && [6, 7, 8, 9].includes(step.step)) {
        const activeExp = PS101State.getActiveExperiment();
        if (step.step === 6 && activeExp) {
          return activeExp.hypothesis && activeExp.successMetric &&
                 (activeExp.duration?.start || activeExp.duration?.review);
        } else if (step.step === 7 && activeExp) {
          return activeExp.obstacles && activeExp.obstacles.length > 0 &&
                 activeExp.obstacles.some(o => o.label && o.strategy);
        } else if (step.step === 8 && activeExp) {
          return activeExp.actions && activeExp.actions.length >= 3;
        } else if (step.step === 9 && activeExp) {
          return activeExp.reflection &&
                 activeExp.reflection.outcome && activeExp.reflection.learning &&
                 activeExp.reflection.confidence?.after;
        }
        return false;
      }

      // Check minimum length (for non-experiment steps)
      if (answer.length < step.minChars) {
        if (!isLastPrompt) {
          const proceed = confirm('This prompt is still under the recommended detail. Continue to the next prompt anyway?');
          if (proceed) {
            return true;
          }
          textarea.focus();
          return false;
        }
        alert(`Please provide at least ${step.minChars} characters for this prompt.`);
        textarea.focus();
        return false;
      }

      // Check maximum length
      if (answer.length > step.maxChars) {
        alert(`Please keep your answer under ${step.maxChars} characters.`);
        textarea.focus();
        return false;
      }

      // Step-specific validation (only for first prompt of step 1)
  if (step.step === 1 && promptIndex === 0) {
    // Step 1, prompt 1 - need at least 2 sentences
    const sentences = answer.split(/[.!?]+/).filter(s => s.trim().length > 0);
    if (sentences.length < 2) {
      if (!isLastPrompt) {
        const proceed = confirm('This intro question works best with a bit more detail. Continue anyway?');
        if (proceed) {
          return true;
        }
      } else {
        alert('Please provide at least 2 sentences describing your situation.');
      }
      textarea.focus();
      return false;
    }
  }

      // Step 5, prompt 1 - need at least 5 solutions
      if (step.step === 5 && promptIndex === 0) {
        const hasNumbers = /[1-5]/.test(answer);
        const hasBullets = /[‚Ä¢\-\*]/.test(answer);
        if (!hasNumbers && !hasBullets && answer.length < 100) {
          alert('Please list at least 5 potential solutions to your problem.');
          return false;
        }
      }

      // Step 8, prompt 1 - should mention specific steps
      if (step.step === 8 && promptIndex === 0) {
        const hasNumbers = /[1-3]/.test(answer);
        const hasBullets = /[‚Ä¢\-\*]/.test(answer);
        if (!hasNumbers && !hasBullets && answer.length < 50) {
          const confirmed = confirm('Your action plan doesn\'t seem to list specific steps. Continue anyway?');
          if (!confirmed) return false;
        }
      }

      return true;
    }

    function handleStepAnswerInput(e) {
      const step = PS101State.getCurrentStep();
      if (!step) return;
      updateCharCount(
        e.target.value.length,
        step?.minChars || 0,
        step?.maxChars || 0
      );
      PS101State.setAnswer(PS101State.currentStep, PS101State.currentPromptIndex, e.target.value);
      const promptIndex = PS101State.currentPromptIndex || 0;
      const totalPrompts = step.prompts ? step.prompts.length : 1;
      updateNavButtons(PS101State.currentStep, promptIndex, totalPrompts);
    }

    // Helper function to escape HTML (Global Scope)
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Experiment Component Render Functions (Global Scope)
    function renderObstacleMapping(experiment) {
      if (!experiment) return;

      const canvas = document.getElementById('experiment-canvas');
      const obstacleMapping = document.getElementById('obstacle-mapping');
      const actionPlan = document.getElementById('action-plan');
      const reflectionLog = document.getElementById('reflection-log');

      // Show obstacle mapping, hide others
      if (canvas) canvas.classList.add('hidden');
      if (obstacleMapping) obstacleMapping.classList.remove('hidden');
      if (actionPlan) actionPlan.classList.add('hidden');
      if (reflectionLog) reflectionLog.classList.add('hidden');

      // Render obstacles list
      const obstaclesList = document.getElementById('obstacles-list');
      if (!obstaclesList) return;

      obstaclesList.innerHTML = '';
      const obstacles = experiment.obstacles || [];

      obstacles.forEach((obs, idx) => {
        const item = document.createElement('div');
        item.className = 'obstacle-item';
        item.innerHTML = `
          <div class="obstacle-header">
            <span class="obstacle-type ${obs.type}">${obs.type}</span>
            <button class="btn-remove" data-obstacle-id="${obs.id}" aria-label="Remove obstacle">√ó</button>
          </div>
          <div><strong>${escapeHtml(obs.label)}</strong></div>
          <div class="obstacle-strategy">Strategy: ${escapeHtml(obs.strategy)}</div>
        `;
        obstaclesList.appendChild(item);
      });

      // Attach remove handlers
      obstaclesList.querySelectorAll('.btn-remove').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const obsId = e.target.dataset.obstacleId;
          if (experiment.obstacles) {
            experiment.obstacles = experiment.obstacles.filter(o => o.id !== obsId);
            PS101State.updateExperiment(experiment.id, { obstacles: experiment.obstacles });
            renderObstacleMapping(experiment);
          }
        });
      });
    }

    function renderActionPlan(experiment) {
      if (!experiment) return;

      const canvas = document.getElementById('experiment-canvas');
      const obstacleMapping = document.getElementById('obstacle-mapping');
      const actionPlan = document.getElementById('action-plan');
      const reflectionLog = document.getElementById('reflection-log');

      // Show action plan, hide others
      if (canvas) canvas.classList.add('hidden');
      if (obstacleMapping) obstacleMapping.classList.add('hidden');
      if (actionPlan) actionPlan.classList.remove('hidden');
      if (reflectionLog) reflectionLog.classList.add('hidden');

      // Render actions list
      const actionsList = document.getElementById('actions-list');
      if (!actionsList) return;

      actionsList.innerHTML = '';
      const actions = experiment.actions || [];

      actions.forEach((action, idx) => {
        const item = document.createElement('div');
        item.className = 'action-item';
        item.innerHTML = `
          <div class="action-header">
            <div class="action-checkbox">
              <input type="checkbox" id="action-${action.id}" ${action.done ? 'checked' : ''} data-action-id="${action.id}">
              <label for="action-${action.id}"><strong>${escapeHtml(action.label)}</strong></label>
            </div>
            <button class="btn-remove" data-action-id="${action.id}" aria-label="Remove action">√ó</button>
          </div>
          ${action.due ? `<div class="action-due">Due: ${escapeHtml(action.due)}</div>` : ''}
          ${action.accountability ? `<div class="action-due">Accountability: ${escapeHtml(action.accountability)}</div>` : ''}
        `;
        actionsList.appendChild(item);

        // Attach checkbox handler
        const checkbox = item.querySelector('input[type="checkbox"]');
        if (checkbox) {
          checkbox.addEventListener('change', (e) => {
            const actionId = e.target.dataset.actionId;
            const action = experiment.actions.find(a => a.id === actionId);
            if (action) {
              action.done = e.target.checked;
              PS101State.updateExperiment(experiment.id, { actions: experiment.actions });
            }
          });
        }
      });

      // Attach remove handlers
      actionsList.querySelectorAll('.btn-remove').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const actionId = e.target.dataset.actionId;
          if (experiment.actions) {
            experiment.actions = experiment.actions.filter(a => a.id !== actionId);
            PS101State.updateExperiment(experiment.id, { actions: experiment.actions });
            renderActionPlan(experiment);
          }
        });
      });
    }

    function renderReflectionLog(experiment) {
      if (!experiment) return;

      const canvas = document.getElementById('experiment-canvas');
      const obstacleMapping = document.getElementById('obstacle-mapping');
      const actionPlan = document.getElementById('action-plan');
      const reflectionLog = document.getElementById('reflection-log');

      // Show reflection log, hide others
      if (canvas) canvas.classList.add('hidden');
      if (obstacleMapping) obstacleMapping.classList.add('hidden');
      if (actionPlan) actionPlan.classList.add('hidden');
      if (reflectionLog) reflectionLog.classList.remove('hidden');

      // Initialize reflection object if it doesn't exist (FIX: Step 9 validation bug)
      if (!experiment.reflection) {
        console.log('[renderReflectionLog] Initializing reflection object for experiment', experiment.id);
        PS101State.updateReflection(experiment.id, {
          outcome: '',
          learning: '',
          confidence: { after: 5 },
          nextMove: 'Continue'
        });
      }

      // Populate fields
      const outcome = document.getElementById('reflection-outcome');
      const learning = document.getElementById('reflection-learning');
      const confidence = document.getElementById('reflection-confidence');
      const confidenceValue = document.getElementById('confidence-value');
      const nextMove = document.getElementById('reflection-next-move');

      const reflection = experiment.reflection || {};

      if (outcome) outcome.value = reflection.outcome || '';
      if (learning) learning.value = reflection.learning || '';
      if (confidence) {
        confidence.value = reflection.confidence?.after || 5;
        if (confidenceValue) {
          confidenceValue.textContent = reflection.confidence?.after || 5;
        }
      }
      if (nextMove) nextMove.value = reflection.nextMove || 'Continue';

      // Update confidence display when slider changes
      if (confidence && confidenceValue) {
        confidence.addEventListener('input', (e) => {
          confidenceValue.textContent = e.target.value;
        });
      }
    }

  // PS101 Event Listeners Setup (extracted for clarity)
  function initPS101EventListeners() {
    // Welcome screen buttons
    const startBtn = document.getElementById('start-ps101');
    if (startBtn) {
      startBtn.addEventListener('click', () => {
        PS101State.currentStep = 1;
        PS101State.save();
        renderCurrentStep();
      });
    }

    const continueBtn = document.getElementById('continue-ps101');
    if (continueBtn) {
      continueBtn.addEventListener('click', () => {
        renderCurrentStep();
      });
    }

    const learnMoreBtn = document.getElementById('learn-more-ps101');
    if (learnMoreBtn) {
      learnMoreBtn.addEventListener('click', () => {
        scrollToSection('about');
      });
    }

    // Navigation buttons
    const backBtn = document.getElementById('ps101-back');
    if (backBtn) {
      backBtn.addEventListener('click', () => {
        PS101State.prevPrompt();
      });
    }

    const nextBtn = document.getElementById('ps101-next');
    if (nextBtn) {
      nextBtn.addEventListener('click', () => {
        const isValid = validateCurrentStep();
        if (isValid) {
          const textarea = document.getElementById('step-answer');
          if (textarea) {
            PS101State.setAnswer(PS101State.currentStep, PS101State.currentPromptIndex, textarea.value);
            PS101State.nextPrompt();
          }
        }
      });
    }

    // Progress dots (click to jump to step)
    document.querySelectorAll('.progress-dots .dot').forEach(dot => {
      dot.addEventListener('click', (e) => {
        if (!e.target.disabled) {
          const stepNumber = parseInt(e.target.dataset.step);
          PS101State.goToStep(stepNumber);
        }
      });
    });

    // Textarea input (auto-save + char count)
    const textarea = document.getElementById('step-answer');
    if (textarea) {
      textarea.removeEventListener('input', handleStepAnswerInput);
      textarea.addEventListener('input', handleStepAnswerInput);
    }

    // Completion screen buttons
    const downloadBtn = document.getElementById('download-summary');
    if (downloadBtn) {
      downloadBtn.addEventListener('click', () => {
        if (typeof downloadSummary === 'function') {
          downloadSummary();
        } else {
          console.warn('[PS101] downloadSummary handler not ready yet');
        }
      });
    }

    const startOverBtn = document.getElementById('start-over');
    if (startOverBtn) {
      startOverBtn.addEventListener('click', () => {
        if (confirm('Are you sure you want to start over? This will clear all your answers.')) {
          PS101State.reset();
        }
      });
    }

    // Experiment component event listeners
    // Experiment Canvas (Step 6) - auto-save on change
    const expHypothesis = document.getElementById('exp-hypothesis');
    const expSuccessMetric = document.getElementById('exp-success-metric');
    const expStartDate = document.getElementById('exp-start-date');
    const expReviewDate = document.getElementById('exp-review-date');
    const expResources = document.getElementById('exp-resources');

    function saveExperimentCanvas() {
      const activeExp = PS101State.getActiveExperiment();
      if (!activeExp) return;

      PS101State.updateExperiment(activeExp.id, {
        hypothesis: expHypothesis?.value || '',
        successMetric: expSuccessMetric?.value || '',
        duration: {
          start: expStartDate?.value || '',
          review: expReviewDate?.value || ''
        },
        resources: expResources?.value || '',
        status: 'draft'
      });
      showAutosaveIndicator('Experiment saved');

      // Update validation to enable Next button
      const step = PS101State.getCurrentStep();
      const totalPrompts = step ? step.prompts.length : 1;
      updateNavButtons(PS101State.currentStep, PS101State.currentPromptIndex, totalPrompts);
    }

    if (expHypothesis) expHypothesis.addEventListener('input', () => saveExperimentCanvas());
    if (expSuccessMetric) expSuccessMetric.addEventListener('input', () => saveExperimentCanvas());
    if (expStartDate) expStartDate.addEventListener('change', () => saveExperimentCanvas());
    if (expReviewDate) expReviewDate.addEventListener('change', () => saveExperimentCanvas());
    if (expResources) expResources.addEventListener('input', () => saveExperimentCanvas());

    // Add Obstacle button (Step 7)
    // Implementation: Replaces browser prompt()/confirm() dialogs with inline form per Decision #003
    const addObstacleBtn = document.getElementById('add-obstacle-btn');
    const addObstacleForm = document.getElementById('add-obstacle-form');
    const saveObstacleBtn = document.getElementById('save-obstacle-btn');
    const cancelObstacleBtn = document.getElementById('cancel-obstacle-btn');
    const obstacleLabelInput = document.getElementById('obstacle-label');
    const obstacleStrategyInput = document.getElementById('obstacle-strategy');
    const obstacleLabelError = document.getElementById('obstacle-label-error');
    const obstacleStrategyError = document.getElementById('obstacle-strategy-error');

    if (addObstacleBtn && addObstacleForm) {
      // Show form when Add button clicked
      addObstacleBtn.addEventListener('click', () => {
        addObstacleForm.classList.remove('hidden');
        addObstacleBtn.style.display = 'none';
        obstacleLabelError.classList.add('hidden');
        obstacleStrategyError.classList.add('hidden');
        setTimeout(() => obstacleLabelInput?.focus(), 50);
      });

      // Cancel button
      if (cancelObstacleBtn) {
        cancelObstacleBtn.addEventListener('click', () => {
          addObstacleForm.classList.add('hidden');
          addObstacleBtn.style.display = 'block';
          if (obstacleLabelInput) obstacleLabelInput.value = '';
          if (obstacleStrategyInput) obstacleStrategyInput.value = '';
          const externalRadio = document.querySelector('input[name="obstacle-type"][value="external"]');
          if (externalRadio) externalRadio.checked = true;
          obstacleLabelError.classList.add('hidden');
          obstacleStrategyError.classList.add('hidden');
        });

        // ESC key handler
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && !addObstacleForm.classList.contains('hidden')) {
            cancelObstacleBtn.click();
          }
        });
      }

      // Save button
      if (saveObstacleBtn) {
        console.log('[saveObstacleBtn] Event listener attached to button');
        saveObstacleBtn.addEventListener('click', () => {
          console.log('[saveObstacleBtn] Click handler FIRED');
          try {
            const label = obstacleLabelInput?.value.trim() || '';
            const strategy = obstacleStrategyInput?.value.trim() || '';
            const typeRadio = document.querySelector('input[name="obstacle-type"]:checked');
            const type = typeRadio?.value || 'external';

            let isValid = true;

            if (!label) {
              obstacleLabelError.textContent = 'Please describe the obstacle.';
              obstacleLabelError.classList.remove('hidden');
              isValid = false;
              obstacleLabelInput?.focus();
            } else {
              obstacleLabelError.classList.add('hidden');
            }

            if (!strategy) {
              obstacleStrategyError.textContent = 'Please add a strategy to overcome this obstacle.';
              obstacleStrategyError.classList.remove('hidden');
              isValid = false;
              if (label) obstacleStrategyInput?.focus();
            } else {
              obstacleStrategyError.classList.add('hidden');
            }

            if (!isValid) {
              console.log('[saveObstacleBtn] Validation failed, returning');
              return;
            }

            const activeExp = PS101State.getActiveExperiment();
            console.log('[saveObstacleBtn] Validation passed! activeExp:', activeExp ? 'exists' : 'null', 'label:', label, 'strategy:', strategy);
            if (activeExp) {
              PS101State.addObstacle(activeExp.id, {
                type: type,
                label: label,
                strategy: strategy
              });
              console.log('[saveObstacleBtn] Obstacle added, obstacles count:', activeExp.obstacles?.length);

              obstacleLabelInput.value = '';
              obstacleStrategyInput.value = '';
              const externalRadioReset = document.querySelector('input[name="obstacle-type"][value="external"]');
              if (externalRadioReset) externalRadioReset.checked = true;
              addObstacleForm.classList.add('hidden');
              addObstacleBtn.style.display = 'block';

              renderObstacleMapping(activeExp);

              // Update validation to enable Next button
              const step = PS101State.getCurrentStep();
              const totalPrompts = step ? step.prompts.length : 1;
              console.log('[saveObstacleBtn] Calling updateNavButtons with step:', PS101State.currentStep, 'promptIndex:', PS101State.currentPromptIndex, 'totalPrompts:', totalPrompts);
              updateNavButtons(PS101State.currentStep, PS101State.currentPromptIndex, totalPrompts);
              console.log('[saveObstacleBtn] updateNavButtons completed');
            } else {
              console.log('[saveObstacleBtn] ERROR: activeExp is null!');
            }
          } catch (error) {
            console.error('[saveObstacleBtn] EXCEPTION:', error);
          }
        });

        // Enter key submission
        if (obstacleLabelInput) {
          obstacleLabelInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
              e.preventDefault();
              saveObstacleBtn.click();
            }
          });
        }
        if (obstacleStrategyInput) {
          obstacleStrategyInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
              e.preventDefault();
              saveObstacleBtn.click();
            }
          });
        }
      }

      // Real-time error clearing
      if (obstacleLabelInput) {
        obstacleLabelInput.addEventListener('input', () => {
          if (obstacleLabelInput.value.trim()) {
            obstacleLabelError.classList.add('hidden');
          }
        });
      }
      if (obstacleStrategyInput) {
        obstacleStrategyInput.addEventListener('input', () => {
          if (obstacleStrategyInput.value.trim()) {
            obstacleStrategyError.classList.add('hidden');
          }
        });
      }
    }

    // Add Action button (Step 8)
    const addActionBtn = document.getElementById('add-action-btn');
    const addActionForm = document.getElementById('add-action-form');
    const saveActionBtn = document.getElementById('save-action-btn');
    const cancelActionBtn = document.getElementById('cancel-action-btn');
    const actionLabelInput = document.getElementById('action-label');
    const actionDueInput = document.getElementById('action-due');
    const actionAccountabilityInput = document.getElementById('action-accountability');
    const actionLabelError = document.getElementById('action-label-error');

    if (addActionBtn && addActionForm) {
      addActionBtn.addEventListener('click', () => {
        addActionForm.classList.remove('hidden');
        addActionBtn.style.display = 'none';
        actionLabelError.classList.add('hidden');
        setTimeout(() => actionLabelInput?.focus(), 50);
      });

      if (cancelActionBtn) {
        cancelActionBtn.addEventListener('click', () => {
          addActionForm.classList.add('hidden');
          addActionBtn.style.display = 'block';
          if (actionLabelInput) actionLabelInput.value = '';
          if (actionDueInput) actionDueInput.value = '';
          if (actionAccountabilityInput) actionAccountabilityInput.value = '';
          actionLabelError.classList.add('hidden');
        });

        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && !addActionForm.classList.contains('hidden')) {
            cancelActionBtn.click();
          }
        });
      }

      if (saveActionBtn) {
        saveActionBtn.addEventListener('click', () => {
          const label = actionLabelInput?.value.trim() || '';
          const due = actionDueInput?.value.trim() || '';
          const accountability = actionAccountabilityInput?.value.trim() || '';

          if (!label) {
            actionLabelError.textContent = 'Please describe the action you will take.';
            actionLabelError.classList.remove('hidden');
            actionLabelInput?.focus();
            return;
          } else {
            actionLabelError.classList.add('hidden');
          }

          const activeExp = PS101State.getActiveExperiment();
          if (activeExp) {
            PS101State.addAction(activeExp.id, {
              label: label,
              due: due,
              accountability: accountability
            });

            actionLabelInput.value = '';
            actionDueInput.value = '';
            actionAccountabilityInput.value = '';
            addActionForm.classList.add('hidden');
            addActionBtn.style.display = 'block';

            renderActionPlan(activeExp);

            // Update validation to enable Next button
            const step = PS101State.getCurrentStep();
            const totalPrompts = step ? step.prompts.length : 1;
            updateNavButtons(PS101State.currentStep, PS101State.currentPromptIndex, totalPrompts);
          }
        });

        if (actionLabelInput) {
          actionLabelInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
              e.preventDefault();
              saveActionBtn.click();
            }
          });
        }
        if (actionDueInput) {
          actionDueInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
              e.preventDefault();
              saveActionBtn.click();
            }
          });
        }
        if (actionAccountabilityInput) {
          actionAccountabilityInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
              e.preventDefault();
              saveActionBtn.click();
            }
          });
        }
      }

      if (actionLabelInput) {
        actionLabelInput.addEventListener('input', () => {
          if (actionLabelInput.value.trim()) {
            actionLabelError.classList.add('hidden');
          }
        });
      }
    }

    // Reflection fields (Step 9) - auto-save
    const reflectionOutcome = document.getElementById('reflection-outcome');
    const reflectionLearning = document.getElementById('reflection-learning');
    const reflectionConfidence = document.getElementById('reflection-confidence');
    const reflectionNextMove = document.getElementById('reflection-next-move');

    function saveReflection() {
      const activeExp = PS101State.getActiveExperiment();
      if (!activeExp) return;

      PS101State.updateReflection(activeExp.id, {
        outcome: reflectionOutcome?.value || '',
        learning: reflectionLearning?.value || '',
        confidence: {
          after: parseInt(reflectionConfidence?.value || '5')
        },
        nextMove: reflectionNextMove?.value || 'Continue'
      });
      showAutosaveIndicator('Reflection saved');

      // Update validation to enable Next button
      const step = PS101State.getCurrentStep();
      const totalPrompts = step ? step.prompts.length : 1;
      updateNavButtons(PS101State.currentStep, PS101State.currentPromptIndex, totalPrompts);
    }

    if (reflectionOutcome) reflectionOutcome.addEventListener('input', () => saveReflection());
    if (reflectionLearning) reflectionLearning.addEventListener('input', () => saveReflection());
    if (reflectionConfidence) reflectionConfidence.addEventListener('change', () => saveReflection());
    if (reflectionNextMove) reflectionNextMove.addEventListener('change', () => saveReflection());

    // Initial render - only show screens if user has progress or completed
    if (PS101State.completed) {
      renderCompletionScreen();
    } else if (PS101State.steps && Object.keys(PS101State.steps).length > 0) {
      renderCurrentStep();
    }
  }

  function softRoute(txt) {
    const t = (txt || '').toLowerCase();
    if (t.includes('questions') || t.includes('fast')) smoothTo('#ps101');
    if (t.includes('explore') || t.includes('discover')) smoothTo('#modules');
    if (t.includes('dashboard')) smoothTo('#dashboard');
  }

  // Enhanced navigation links
  $('#showJourney').addEventListener('click', e => {
    e.preventDefault();
    smoothTo('#modules');
  });

  $('#linkFast').addEventListener('click', e => {
    e.preventDefault();
    // Show PS101 welcome screen or continue existing flow
    const welcomeScreen = document.getElementById('ps101-welcome');
    const flow = document.getElementById('ps101-flow');

    // Wait for PS101 to initialize
    setTimeout(() => {
      if (window.PS101State && window.PS101State.steps && Object.keys(window.PS101State.steps).length > 0 && !window.PS101State.completed) {
        // User has progress - show current step
        if (window.renderCurrentStep) {
          window.renderCurrentStep();
          if (flow) flow.scrollIntoView({ behavior: 'smooth' });
        }
      } else if (window.renderWelcomeScreen) {
        // New user - show welcome screen
        window.renderWelcomeScreen();
        if (welcomeScreen) welcomeScreen.scrollIntoView({ behavior: 'smooth' });
      } else {
        // Fallback: scroll to PS101 module
        smoothTo('#ps101');
      }
    }, 100);
  });

  $('#linkDiscover').addEventListener('click', e => {
    e.preventDefault();
    smoothTo('#modules');
  });

  // Enhanced ask coach module links
  document.querySelectorAll('[data-coach]').forEach(a => {
    a.addEventListener('click', (e) => {
      e.preventDefault();
      const msg = a.getAttribute('data-coach');
      chat.style.display = 'block';
      chatInput.value = msg;
      chatInput.focus();
      send();
    });
  });

  // Performance monitoring
  if ('performance' in window) {
    window.addEventListener('load', () => {
      setTimeout(() => {
        const perfData = performance.timing;
        const loadTime = perfData.loadEventEnd - perfData.navigationStart;
        console.log(`Page loaded in ${loadTime}ms`);
      }, 0);
    });
  }

  // Authentication event handlers
  ensureConfig().then(()=>{
    if(sessionId){
      callJson('/wimd/metrics').catch(()=>{ renderMetrics(null); });
    } else {
      renderMetrics(null);
    }
  }).catch(()=>{
    renderMetrics(null);
  });

  const loginForm = $('#loginForm');
  if(loginForm){
    loginForm.addEventListener('submit', async e => {
      e.preventDefault();
      const email = $('#loginEmail').value;
      const password = $('#loginPassword').value;
      await authenticateUser(email, password, false);
    });
  }

  const registerForm = $('#registerForm');
  if(registerForm){
    registerForm.addEventListener('submit', async e => {
      e.preventDefault();
      const email = $('#registerEmail').value;
      const password = $('#registerPassword').value;
      const confirm = $('#registerConfirm').value;
      const discountCode = $('#registerDiscountCode')?.value?.trim() || null;

      if(password !== confirm){
        setStatus($('#authStatus'), 'passwords do not match', 'error');
        return;
      }

      await authenticateUser(email, password, true, discountCode);
    });
  }

  const toggleAuth = $('#toggleAuth');
  if(toggleAuth){
    toggleAuth.addEventListener('click', e => {
      e.preventDefault();
      const loginForm = $('#loginForm');
      const registerForm = $('#registerForm');
      const isLogin = !loginForm.hidden;

      if(isLogin){
        loginForm.hidden = true;
        registerForm.hidden = false;
        toggleAuth.textContent = 'already have an account?';
      } else {
        loginForm.hidden = false;
        registerForm.hidden = true;
        toggleAuth.textContent = 'need an account?';
      }
    });
  }

  const clearSession = $('#clearSession');
  if(clearSession){
    clearSession.addEventListener('click', e => {
      e.preventDefault();
      logout();
    });
  }

  const logoutBtn = $('#logoutBtn');
  if(logoutBtn){
    logoutBtn.addEventListener('click', e => {
      e.preventDefault();
      logout();
    });
  }

  // Password reset
  const forgotPassword = $('#forgotPassword');
  const resetModal = $('#resetModal');
  const resetForm = $('#resetForm');
  const closeReset = $('#closeReset');

  if(forgotPassword){
    forgotPassword.addEventListener('click', e => {
      e.preventDefault();
      resetModal.style.display = 'flex';
    });
  }

  if(closeReset){
    closeReset.addEventListener('click', () => {
      resetModal.style.display = 'none';
      const resetStatus = $('#resetStatus');
      if(resetStatus) resetStatus.textContent = '';
      const resetEmail = $('#resetEmail');
      if(resetEmail) resetEmail.value = '';
    });
  }

  if(resetForm){
    resetForm.addEventListener('submit', async e => {
      e.preventDefault();
      await ensureConfig();
      const email = $('#resetEmail').value;
      const resetStatus = $('#resetStatus');

      setStatus(resetStatus, 'sending reset link...');

      try {
        const response = await fetch(`${apiBase}/auth/reset-password`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email })
        });

        const data = await response.json();

        if(response.ok){
          setStatus(resetStatus, 'password reset link sent to your email', 'ok');
          setTimeout(() => {
            resetModal.style.display = 'none';
            if(resetStatus) resetStatus.textContent = '';
            const resetEmail = $('#resetEmail');
            if(resetEmail) resetEmail.value = '';
          }, 3000);
        } else {
          setStatus(resetStatus, data.detail || 'reset failed', 'error');
        }
      } catch(error){
        setStatus(resetStatus, 'reset request failed - please try again', 'error');
      }
    });
  }

  // Ensure initApp runs once DOM is ready (kept inside primary IIFE for scope access)
  const initAppType = typeof initApp;
  console.log('[INIT BOOTSTRAP] initApp typeof check:', initAppType);

  if (initAppType !== 'function') {
    console.error('[FATAL] initApp function was not defined! Check for errors above.');
    console.error('[DEBUG] Document ready state:', document.readyState);
    return;
  }

  console.log('[INIT SETUP] initApp is defined, setting up initialization...');

  const safeInitApp = () => {
    try {
      console.log('[INIT TRIGGER] Starting initialization');
      initApp();
    } catch (error) {
      console.error('[INIT ERROR] Failed to initialize app:', error);
      document.body.insertAdjacentHTML('beforeend', `
        <div style="position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
                    background: #ff4444; color: white; padding: 20px; border-radius: 8px;
                    z-index: 999999; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
          <strong>Initialization Error</strong><br>
          The application failed to start. Please refresh the page.<br>
          <small>Error: ${error.message}</small>
        </div>
      `);
    }
  };

  // Navigation scroll function
  function scrollToSection(sectionId) {
    const section = document.getElementById(sectionId);
    if (section) {
      section.scrollIntoView({ behavior: 'smooth' });
      // If it's the feedback section, make sure it's visible
      if (sectionId === 'feedback') {
        section.style.display = 'block';
        section.style.visibility = 'visible';
      }
    }
  }

  // Make scrollToSection globally accessible
  window.scrollToSection = scrollToSection;

  // Enhanced API error handling
  const originalFetch = window.fetch;
  window.fetch = function(...args) {
    return originalFetch.apply(this, args)
      .catch(error => {
        console.warn('Network request failed:', error);
        // Show user-friendly error message
        const statusEl = document.getElementById('apiStatus');
        if (statusEl) {
          statusEl.textContent = 'working offline';
          statusEl.className = 'status error';
        }
        throw error;
      });
  };

  if (document.readyState === 'loading') {
    console.log('[INIT SETUP] DOM still loading, adding listener');
    document.addEventListener('DOMContentLoaded', safeInitApp, { once: true });
  } else {
    console.log('[INIT SETUP] DOM already ready, initializing immediately');
    setTimeout(safeInitApp, 0);
  }

})();

  // PS101 Implementation
  (function() {
    'use strict';

    // PS101 Framework Definition (10-step canonical)
    const PS101_STEPS = [
      {
        step: 1,
        title: "Problem Identification and Delta Analysis",
        prompts: [
          "What specific challenge are you currently facing in your personal or professional life?",
          "Why is it a problem?",
          "Reduce this to a simple problem statement",
          "If you were to wake up tomorrow and this problem was solved, what would be different? (Miracle Question)",
          "What is the 'delta' or gap between your current situation and your desired state?",
          "How would solving this problem align with your long-term goals or values?"
        ],
        minChars: 50,
        maxChars: 1000
      },
      {
        step: 2,
        title: "Current Situation Analysis",
        prompts: [
          "Describe your current situation in detail. What factors are contributing to the problem?",
          "What attempts have you made so far to address this issue? What were the outcomes?",
          "Are there any patterns or recurring themes you've noticed related to this problem?",
          "How is this problem affecting different areas of your life (e.g., career, relationships, personal growth)?"
        ],
        minChars: 30,
        maxChars: 1000
      },
      {
        step: 3,
        title: "Root Cause Exploration",
        prompts: [
          "What do you believe are the underlying causes of this problem?",
          "Are there any assumptions you're making about the problem or its causes?",
          "How might your own beliefs, habits, or past experiences be contributing to the situation?"
        ],
        minChars: 30,
        maxChars: 1000
      },
      {
        step: 4,
        title: "Self-Efficacy Assessment",
        prompts: [
          "On a scale of 1-10, how confident do you feel in your ability to solve this problem? Why?",
          "What past experiences or skills can you draw upon to address this challenge?",
          "How might your perception of your own capabilities be influencing your approach to this problem?",
          "What small wins or successes have you had in the past that you can build upon?"
        ],
        minChars: 30,
        maxChars: 1000
      },
      {
        step: 5,
        title: "Solution Brainstorming",
        prompts: [
          "List at least five potential solutions to your problem, no matter how unconventional they may seem.",
          "For each solution, what are the potential benefits and drawbacks?",
          "Which solution feels most aligned with your values and long-term goals?",
          "How might you combine elements from different solutions to create a more comprehensive approach?"
        ],
        minChars: 100,
        maxChars: 1000
      },
      {
        step: 6,
        title: "Experimental Design",
        prompts: [
          "Based on your chosen solution(s), what small, low-risk experiment could you conduct to test its effectiveness?",
          "What specific, measurable outcome would indicate that your experiment was successful?",
          "What resources or support might you need to carry out this experiment?"
        ],
        minChars: 30,
        maxChars: 1000
      },
      {
        step: 7,
        title: "Obstacle Identification",
        prompts: [
          "What external factors (e.g., time, resources, other people) might hinder your progress?",
          "What internal obstacles (e.g., self-doubt, fear, lack of knowledge) do you anticipate facing?"
        ],
        minChars: 30,
        maxChars: 1000
      },
      {
        step: 8,
        title: "Action Planning",
        prompts: [
          "What specific steps will you take to implement your chosen experiment?",
          "How will you measure and track your progress throughout the experiment?"
        ],
        minChars: 30,
        maxChars: 1000
      },
      {
        step: 9,
        title: "Reflection and Iteration",
        prompts: [
          "After conducting your experiment, what were the results? What did you learn?",
          "How has this experience affected your confidence in problem-solving?"
        ],
        minChars: 30,
        maxChars: 1000
      },
      {
        step: 10,
        title: "Building Mastery and Self-Efficacy",
        prompts: [
          "Reflecting on this problem-solving process, what new skills or knowledge have you gained?",
          "How can you apply what you've learned to future challenges or goals?",
          "What strategies will you use to maintain momentum and continue building your problem-solving abilities?",
          "How has this experience changed your perception of your own capabilities?"
        ],
        minChars: 30,
        maxChars: 1000
      }
    ];

    const PROMPT_HINTS = {
      1: [
        'Aim for at least two sentences describing what feels stuck right now. Example: "I\'m trying to pivot into product roles but I feel lost about where to begin."',
        'Describe why this matters to you. For instance: "It matters because I want more creative ownership."',
        'Try a single-sentence problem statement such as: "I want to transition to product management within six months."',
        'Paint a picture of success‚Äîone or two sentences about what life looks like when this is solved.',
        'Spell out the gap between today and that desired state. Mention what\'s missing.',
        'Add a quick note on how solving this ties to your bigger goals or values.'
      ],
      2: [
        'Describe your current situation in detail‚Äîwhat factors are contributing to the problem?',
        'Share what attempts you\'ve made so far. What were the outcomes?',
        'Are there any patterns or recurring themes you\'ve noticed?',
        'How is this problem affecting different areas of your life?'
      ],
      3: [
        'What underlying beliefs or assumptions might be contributing to this problem?',
        'Are there any systemic or environmental factors at play?',
        'What would need to change for this problem to disappear?'
      ],
      4: [
        'On a scale of 1-10, rate your confidence and explain why.',
        'What past experiences or skills can you draw upon?',
        'How might your perception of your capabilities be influencing your approach?',
        'What small wins or successes can you build upon?'
      ],
      5: [
        'What specific, measurable outcomes would indicate you\'ve solved this problem?',
        'What resources or support would be most helpful?',
        'What is a realistic timeline for making progress?',
        'What potential obstacles might you face, and how could you address them?'
      ],
      6: [
        'Define your experiment hypothesis‚Äîwhat do you want to test?',
        'What success metrics will you track?',
        'When will you start and review progress?'
      ],
      7: [
        'What obstacles do you anticipate?',
        'For each obstacle, what strategy could help overcome it?'
      ],
      8: [
        'What are the first 3 concrete actions you\'ll take?',
        'When will you complete each action?'
      ],
      9: [
        'What was the outcome of your experiment?',
        'What did you learn from this experience?'
      ],
      10: [
        'What new skills or knowledge have you gained?',
        'How can you apply what you\'ve learned to future challenges?',
        'What strategies will you use to maintain momentum?',
        'How has this experience changed your perception of your capabilities?'
      ]
    };

    // State Object (v2 - multi-prompt + experiments)
    const PS101State = {
      currentStep: 1,
      currentPromptIndex: 0,
      steps: {}, // { "1": { prompts: [{ response: "...", completedAt: "..." }] } }
      experiments: [], // Array of experiment objects
      startedAt: null,
      lastUpdated: null,
      completed: false,
      completionScores: {},

      // Initialize state
      init() {
        console.log('[PS101] Initializing state...');
        console.log('[PS101] Canonical PS101_STEPS has', PS101_STEPS.length, 'steps');

        // CRITICAL FIX: Validate any loaded state against canonical PS101_STEPS
        const validateState = (state) => {
          // Force currentStep to be within 1-10 range
          if (state.currentStep < 1 || state.currentStep > PS101_STEPS.length) {
            console.warn('[PS101] Invalid currentStep:', state.currentStep, '- resetting to 1');
            state.currentStep = 1;
          }

          // Ensure currentPromptIndex is valid for the current step
          const step = PS101_STEPS[state.currentStep - 1];
          if (step && state.currentPromptIndex >= step.prompts.length) {
            console.warn('[PS101] Invalid currentPromptIndex:', state.currentPromptIndex, '- resetting to 0');
            state.currentPromptIndex = 0;
          }

          return state;
        };

        // Try v2 first, then fall back to v1 for migration
        const savedState = localStorage.getItem('ps101_v2_state');
        if (savedState) {
          try {
            const parsed = JSON.parse(savedState);
            console.log('[PS101] Loaded v2 state - currentStep:', parsed.currentStep);
            Object.assign(this, validateState(parsed));
          } catch (e) {
            console.error('[PS101] Failed to parse saved PS101 v2 state:', e);
            // Clear corrupted state
            localStorage.removeItem('ps101_v2_state');
          }
        } else {
          // Migrate from v1 if exists
          const v1State = localStorage.getItem('ps101_state');
          if (v1State) {
            try {
              const parsed = JSON.parse(v1State);
              console.log('[PS101] Migrating from v1 state - currentStep:', parsed.currentStep);
              // Migrate old structure to new
              if (parsed.answers) {
                this.steps = {};
                Object.keys(parsed.answers).forEach(stepNum => {
                  // Only migrate steps that exist in canonical PS101_STEPS
                  const stepInt = parseInt(stepNum);
                  if (stepInt >= 1 && stepInt <= PS101_STEPS.length) {
                    this.steps[stepNum] = {
                      prompts: [{ response: parsed.answers[stepNum], completedAt: parsed.lastUpdated || new Date().toISOString() }]
                    };
                  }
                });
              }
              this.currentStep = parsed.currentStep || 1;
              this.startedAt = parsed.startedAt;
              this.completed = parsed.completed || false;
              validateState(this);
              this.save(); // Save in new format
              localStorage.removeItem('ps101_state'); // Clean up old
            } catch (e) {
              console.error('[PS101] Failed to migrate PS101 v1 state:', e);
              // Clear corrupted state
              localStorage.removeItem('ps101_state');
            }
          }
        }

        if (!this.startedAt) {
          this.startedAt = new Date().toISOString();
        }

        // Initialize steps structure if empty
        if (!this.steps || Object.keys(this.steps).length === 0) {
          this.steps = {};
        }

        // Initialize experiments if empty
        if (!this.experiments || !Array.isArray(this.experiments)) {
          this.experiments = [];
        }
      },

      // Save state
      save() {
        this.lastUpdated = new Date().toISOString();
        localStorage.setItem('ps101_v2_state', JSON.stringify(this));
      },

      // Get current step data
      getCurrentStep() {
        return PS101_STEPS.find(s => s.step === this.currentStep);
      },

      // Get current prompt data
      getCurrentPrompt() {
        const step = this.getCurrentStep();
        if (!step || !step.prompts) return null;
        return step.prompts[this.currentPromptIndex] || step.prompts[0];
      },

      // Get answer for step/prompt
      getAnswer(stepNumber, promptIndex = 0) {
        if (this.steps[stepNumber] && this.steps[stepNumber].prompts && this.steps[stepNumber].prompts[promptIndex]) {
          return this.steps[stepNumber].prompts[promptIndex].response || '';
        }
        return '';
      },

      // Set answer for step/prompt
      setAnswer(stepNumber, promptIndex, answer) {
        if (!this.steps[stepNumber]) {
          this.steps[stepNumber] = { prompts: [] };
        }
        if (!this.steps[stepNumber].prompts) {
          this.steps[stepNumber].prompts = [];
        }
        // Ensure array is large enough
        while (this.steps[stepNumber].prompts.length <= promptIndex) {
          this.steps[stepNumber].prompts.push({ response: '', completedAt: null });
        }
        this.steps[stepNumber].prompts[promptIndex] = {
          response: answer,
          completedAt: answer ? new Date().toISOString() : null
        };
        this.save();
      },

      // Get all answers for a step (for display)
      getStepAnswers(stepNumber) {
        if (this.steps[stepNumber] && this.steps[stepNumber].prompts) {
          return this.steps[stepNumber].prompts.map(p => p.response || '');
        }
        return [];
      },

      // Check if step is complete (all prompts answered with min chars)
      isStepComplete(stepNumber) {
        const step = PS101_STEPS.find(s => s.step === stepNumber);
        if (!step) return false;
        const answers = this.getStepAnswers(stepNumber);
        if (answers.length !== step.prompts.length) return false;
        return answers.every((answer, idx) => answer.length >= step.minChars);
      },

      // Navigate to step
      goToStep(stepNumber, promptIndex = 0) {
        if (stepNumber >= 1 && stepNumber <= PS101_STEPS.length) {
          this.currentStep = stepNumber;
          this.currentPromptIndex = promptIndex;
          this.save();
          renderCurrentStep();
        }
      },

      // Next prompt within step, or next step if all prompts done
      nextPrompt() {
        console.log('[PS101] nextPrompt called:', {
          currentStep: this.currentStep,
          currentPromptIndex: this.currentPromptIndex,
          savedState: localStorage.getItem('ps101_v2_state')?.substring(0, 100)
        });

        const step = this.getCurrentStep();
        if (!step || !step.prompts) {
          console.error('[PS101] nextPrompt: No step or prompts found!');
          return;
        }

        const totalPrompts = step.prompts.length;
        console.log('[PS101] Current position: Step', this.currentStep, 'Prompt', (this.currentPromptIndex + 1), 'of', totalPrompts);

        if (this.currentPromptIndex + 1 < totalPrompts) {
          // Move to next prompt in same step
          this.currentPromptIndex++;
          console.log('[PS101] ‚Üí Advancing to prompt', (this.currentPromptIndex + 1), 'of', totalPrompts);
          this.save();
          renderCurrentStep();
        } else {
          // All prompts done, move to next step
          console.log('[PS101] ‚Üí All prompts complete, calling nextStep()');
          this.nextStep();
        }
      },

      // Previous prompt within step, or previous step
      prevPrompt() {
        if (this.currentPromptIndex > 0) {
          // Move to previous prompt in same step
          this.currentPromptIndex--;
          this.save();
          renderCurrentStep();
        } else {
          // Move to previous step
          this.prevStep();
        }
      },

      // Next step (only called when all prompts in current step are complete)
      nextStep() {
        console.log('[PS101] nextStep called:', {
          currentStep: this.currentStep,
          maxSteps: PS101_STEPS.length
        });

        if (this.currentStep < PS101_STEPS.length) {
          const oldStep = this.currentStep;
          this.currentStep++;
          this.currentPromptIndex = 0; // Reset to first prompt of new step
          console.log('[PS101] ‚Üí Advanced from Step', oldStep, 'to Step', this.currentStep);
          this.save();
          console.log('[PS101] ‚Üí State saved, calling renderCurrentStep()');
          renderCurrentStep();
        } else {
          console.log('[PS101] ‚Üí Flow complete! Showing completion screen');
          this.completed = true;
          this.save();
          renderCompletionScreen();
        }
      },

      // Previous step
      prevStep() {
        if (this.currentStep > 1) {
          this.currentStep--;
          const step = this.getCurrentStep();
          // Set to last prompt of previous step, or 0 if no prompts
          this.currentPromptIndex = step && step.prompts ? Math.max(0, step.prompts.length - 1) : 0;
          this.save();
          renderCurrentStep();
        }
      },

      // Reset
      reset() {
        this.currentStep = 1;
        this.currentPromptIndex = 0;
        this.steps = {};
        this.experiments = [];
        this.startedAt = new Date().toISOString();
        this.lastUpdated = null;
        this.completed = false;
        this.completionScores = {};
        this.save();
        renderWelcomeScreen();
      },

      // Experiment Management Methods
      createExperiment(title = null) {
        const expId = `exp-${Date.now()}`;
        const experiment = {
          id: expId,
          title: title || `Experiment ${this.experiments.length + 1}`,
          hypothesis: '',
          successMetric: '',
          duration: { start: '', review: '' },
          resources: '',
          obstacles: [],
          actions: [],
          reflection: null,
          status: 'draft',
          createdAt: new Date().toISOString()
        };
        this.experiments.push(experiment);
        this.save();
        return experiment;
      },

      getActiveExperiment() {
        return this.experiments.find(e => e.status === 'active') || this.experiments[this.experiments.length - 1];
      },

      updateExperiment(expId, updates) {
        const exp = this.experiments.find(e => e.id === expId);
        if (exp) {
          Object.assign(exp, updates);
          exp.lastUpdated = new Date().toISOString();
          this.save();
          return exp;
        }
        return null;
      },

      addObstacle(expId, obstacle) {
        const exp = this.getActiveExperiment() || this.experiments.find(e => e.id === expId);
        if (exp) {
          if (!exp.obstacles) exp.obstacles = [];
          exp.obstacles.push({
            id: `obs-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
            type: obstacle.type || 'external',
            label: obstacle.label || '',
            strategy: obstacle.strategy || '',
            createdAt: new Date().toISOString()
          });
          this.save();
          return exp;
        }
        return null;
      },

      addAction(expId, action) {
        const exp = this.getActiveExperiment() || this.experiments.find(e => e.id === expId);
        if (exp) {
          if (!exp.actions) exp.actions = [];
          exp.actions.push({
            id: `act-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
            label: action.label || '',
            due: action.due || '',
            done: false,
            accountability: action.accountability || '',
            createdAt: new Date().toISOString()
          });
          this.save();
          return exp;
        }
        return null;
      },

      updateReflection(expId, reflection) {
        const exp = this.getActiveExperiment() || this.experiments.find(e => e.id === expId);
        if (exp) {
          // Get confidence from Step 4 if available
          const step4Answers = this.getStepAnswers(4);
          const confidenceBefore = step4Answers[0] ? parseInt(step4Answers[0].match(/\d+/)?.[0] || '5') : null;

          exp.reflection = {
            outcome: reflection.outcome || '',
            learning: reflection.learning || '',
            confidence: {
              before: confidenceBefore || reflection.confidence?.before || null,
              after: reflection.confidence?.after || null
            },
            nextMove: reflection.nextMove || 'Continue',
            completedAt: new Date().toISOString()
          };
          exp.status = 'reviewed';
          this.save();
          return exp;
        }
        return null;
      }
    };

    // Initialize
    PS101State.init();

    // Expose to global scope
    window.PS101State = PS101State;
    window.PS101_STEPS = PS101_STEPS;
    window.renderWelcomeScreen = renderWelcomeScreen;
    window.renderCurrentStep = renderCurrentStep;
    window.updateNavButtons = updateNavButtons;

    // Update progress indicator
    function updateProgressIndicator(currentStep) {
      // CRITICAL: Validate currentStep is within bounds
      const validStep = Math.max(1, Math.min(currentStep, PS101_STEPS.length));
      if (validStep !== currentStep) {
        console.error('[PS101] Invalid currentStep:', currentStep, '- clamping to', validStep);
        PS101State.currentStep = validStep;
        PS101State.save();
      }

      const dots = document.querySelectorAll('.progress-dots .dot');
      dots.forEach((dot, index) => {
        const stepNumber = index + 1;
        dot.classList.remove('completed', 'active');
        if (stepNumber < validStep) {
          dot.classList.add('completed');
          dot.disabled = false;
        } else if (stepNumber === validStep) {
          dot.classList.add('active');
          dot.setAttribute('aria-current', 'step');
          dot.disabled = false;
        } else {
          dot.disabled = true;
        }
      });

      const stepLabel = document.getElementById('step-label');
      const step = PS101_STEPS[validStep - 1];
      if (stepLabel && step) {
        // ALWAYS show "of 10" using PS101_STEPS.length, never hardcode
        const totalSteps = PS101_STEPS.length;
        stepLabel.textContent = `Step ${validStep} of ${totalSteps}: ${step.title}`;
        console.log('[PS101] Updated label: Step', validStep, 'of', totalSteps);
      }
    }

    // Update character count
    function updateCharCount(current, minRequired = 0, max = 0) {
      const currentEl = document.getElementById('char-current');
      const maxEl = document.getElementById('char-max');
      const minEl = document.getElementById('char-min');
      const charCount = document.getElementById('char-count');

      if (currentEl) currentEl.textContent = current;
      if (maxEl) maxEl.textContent = max;

      if (minEl) {
        if (minRequired) {
          minEl.textContent = `(min ${minRequired})`;
          minEl.style.display = '';
        } else {
          minEl.textContent = '';
          minEl.style.display = 'none';
        }
      }

      if (charCount) {
        const needsDetail = minRequired > 0 && current < minRequired;
        const nearLimit = !needsDetail && max > 0 && current > max * 0.9;

        charCount.classList.toggle('needs-detail', needsDetail);
        charCount.classList.toggle('near-limit', nearLimit);
        if (!needsDetail && !nearLimit) {
          charCount.style.color = '';
        } else {
          charCount.style.color = '';
        }

        let ariaStatus;
        if (needsDetail) {
          ariaStatus = `Need at least ${minRequired} characters. Currently at ${current}.`;
        } else if (minRequired) {
          ariaStatus = `Characters ${current} of ${max}. Minimum required ${minRequired}.`;
        } else {
          ariaStatus = `Characters ${current} of ${max}.`;
        }
        charCount.setAttribute('aria-label', ariaStatus);
        charCount.setAttribute('title', ariaStatus);
      }
    }

    // Update navigation buttons
    function updateNavButtons(currentStep, promptIndex, totalPrompts) {
      const backBtn = document.getElementById('ps101-back');
      const nextBtn = document.getElementById('ps101-next');

      if (backBtn) {
        // Disable back only if at first prompt of first step
        backBtn.disabled = (currentStep === 1 && promptIndex === 0);
        backBtn.textContent = '‚Üê Back';
      }

      if (nextBtn) {
        const isLastStep = currentStep === 10;
        const isLastPrompt = promptIndex === totalPrompts - 1;

        // Button text based on position
        if (isLastStep && isLastPrompt) {
          nextBtn.textContent = 'Complete PS101 ‚Üí';
        } else if (!isLastPrompt) {
          nextBtn.textContent = 'Next Prompt ‚Üí';
        } else {
          nextBtn.textContent = 'Next Step ‚Üí';
        }

        let isValid = true;
        if (isLastPrompt) {
          // For experiment steps (6-9), validate experiment component instead of textarea
          if ([6, 7, 8, 9].includes(currentStep)) {
            const activeExp = PS101State.getActiveExperiment();
            console.log('[updateNavButtons] Step', currentStep, 'activeExp:', activeExp ? 'exists' : 'null', 'isLastPrompt:', isLastPrompt);
            if (currentStep === 6 && activeExp) {
              isValid = activeExp.hypothesis && activeExp.successMetric &&
                       (activeExp.duration?.start || activeExp.duration?.review);
              console.log('[updateNavButtons] Step 6 validation:', isValid);
            } else if (currentStep === 7 && activeExp) {
              const hasObstacles = activeExp.obstacles && activeExp.obstacles.length > 0;
              const validObstacle = activeExp.obstacles ? activeExp.obstacles.some(o => o.label && o.strategy) : false;
              isValid = hasObstacles && validObstacle;
              console.log('[updateNavButtons] Step 7 validation: obstacles=', activeExp.obstacles?.length || 0, 'hasObstacles:', hasObstacles, 'validObstacle:', validObstacle, 'isValid:', isValid);
              if (activeExp.obstacles && activeExp.obstacles.length > 0) {
                console.log('[updateNavButtons] First obstacle:', {label: !!activeExp.obstacles[0].label, strategy: !!activeExp.obstacles[0].strategy});
              }
            } else if (currentStep === 8 && activeExp) {
              isValid = activeExp.actions && activeExp.actions.length >= 3;
              console.log('[updateNavButtons] Step 8 validation: actions=', activeExp.actions?.length || 0, 'isValid:', isValid);
            } else if (currentStep === 9 && activeExp) {
              isValid = activeExp.reflection &&
                       activeExp.reflection.outcome && activeExp.reflection.learning &&
                       activeExp.reflection.confidence?.after;
              console.log('[updateNavButtons] Step 9 validation:', isValid);
            }
          } else {
            // For regular steps, validate textarea answer
            const currentAnswer = PS101State.getAnswer(currentStep, promptIndex);
            const step = PS101_STEPS.find(s => s.step === currentStep);
            isValid = currentAnswer.length >= (step ? step.minChars : 30);
          }
    }

    nextBtn.disabled = !isValid;
  }
}

    function handleStepAnswerInput(e) {
      const step = PS101State.getCurrentStep();
      if (!step) return;
      updateCharCount(
        e.target.value.length,
        step?.minChars || 0,
        step?.maxChars || 0
      );
      PS101State.setAnswer(PS101State.currentStep, PS101State.currentPromptIndex, e.target.value);
      const promptIndex = PS101State.currentPromptIndex || 0;
      const totalPrompts = step.prompts ? step.prompts.length : 1;
      updateNavButtons(PS101State.currentStep, promptIndex, totalPrompts);
    }

    // Render previous answers
    function renderPreviousAnswers(currentStep) {
      const previousSteps = currentStep - 1;
      const previousAnswersEl = document.getElementById('previous-answers');

      if (!previousAnswersEl) return;

      if (previousSteps === 0) {
        previousAnswersEl.classList.add('hidden');
        return;
      }

      previousAnswersEl.classList.remove('hidden');
      const summaryText = previousAnswersEl.querySelector('.summary-text');
      if (summaryText) {
        summaryText.textContent = `‚ñº Previous Answers (${previousSteps} step${previousSteps > 1 ? 's' : ''} completed)`;
      }

      const answerList = previousAnswersEl.querySelector('.answer-list');
      if (!answerList) return;

      answerList.innerHTML = '';

      for (let i = 1; i < currentStep; i++) {
        const step = PS101_STEPS.find(s => s.step === i);
        if (!step) continue;

        const stepAnswers = PS101State.getStepAnswers(i);
        const hasAnswers = stepAnswers.some(a => a && a.trim().length > 0);

        if (!hasAnswers) continue;

        const card = document.createElement('div');
        card.className = 'answer-card';
        card.dataset.step = i;

        // Show summary of all prompts if multiple, or single answer
        let answerSummary = '';
        if (step.prompts.length > 1) {
          answerSummary = stepAnswers
            .map((ans, idx) => ans && ans.trim() ? `<div class="prompt-summary"><strong>Prompt ${idx + 1}:</strong> ${escapeHtml(ans.substring(0, 200))}${ans.length > 200 ? '...' : ''}</div>` : '')
            .filter(s => s)
            .join('');
        } else {
          answerSummary = escapeHtml(stepAnswers[0] || '');
        }

        card.innerHTML = `
          <div class="answer-header">
            <span class="answer-step">Step ${i}: ${step.title}</span>
            <button class="answer-edit" data-step="${i}" aria-label="Edit Step ${i}">Edit</button>
          </div>
          <div class="answer-content">${answerSummary || 'No answers yet'}</div>
        `;

        answerList.appendChild(card);
      }

      // Add click handlers for edit buttons
      document.querySelectorAll('.answer-edit').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const stepNumber = parseInt(e.target.dataset.step);
          PS101State.goToStep(stepNumber);
        });
      });
    }

    // Render current step
    function renderCurrentStep() {
      const state = PS101State;
      const step = state.getCurrentStep();

      if (!step || !step.prompts) {
        console.error('Invalid step or prompts:', state.currentStep);
        return;
      }

      // Hide welcome/completion, show main flow
      const welcome = document.getElementById('ps101-welcome');
      const completion = document.getElementById('ps101-completion');
      const flow = document.getElementById('ps101-flow');

      if (welcome) welcome.classList.add('hidden');
      if (completion) completion.classList.add('hidden');
      if (flow) flow.classList.remove('hidden');

      // Update progress indicator
      updateProgressIndicator(state.currentStep);

      // Get current prompt
      const promptIndex = state.currentPromptIndex || 0;
      const currentPrompt = step.prompts[promptIndex] || step.prompts[0];
      const totalPrompts = step.prompts.length;

      // Update question text with prompt progress
      const questionText = document.getElementById('question-text');
      if (questionText) {
        const promptProgress = totalPrompts > 1 ? ` (Prompt ${promptIndex + 1} of ${totalPrompts})` : '';
        questionText.textContent = currentPrompt + promptProgress;
        questionText.setAttribute('aria-label', `Step ${state.currentStep}${promptProgress}: ${currentPrompt}`);
      }

      // Update hint (optional, hide if no hint available)
      const hintText = document.getElementById('hint-text');
      const coachingHint = document.getElementById('coaching-hint');
      if (hintText) {
        const stepHints = PROMPT_HINTS[state.currentStep] || [];
        const specificHint = stepHints[promptIndex];
        const minimumDetail = step.minChars || 30;
        hintText.textContent = specificHint
          ? `${specificHint} Aim for about ${minimumDetail} characters so the Next Prompt button can unlock.`
          : `Take your time to reflect on this question. Aim for about ${minimumDetail} characters so the Next Prompt button can unlock.`;
      }
      if (coachingHint) {
        coachingHint.style.display = 'block'; // Keep visible for now
      }

      // Update textarea
      const textarea = document.getElementById('step-answer');
      if (textarea) {
        const answer = state.getAnswer(state.currentStep, promptIndex);
        textarea.value = answer;
        textarea.placeholder = `Type your response to: ${currentPrompt.substring(0, 50)}...`;
        textarea.setAttribute('maxlength', step.maxChars);
        updateCharCount(
          answer.length,
          step?.minChars || 0,
          step?.maxChars || 0
        );
        textarea.removeEventListener('input', handleStepAnswerInput);
        textarea.addEventListener('input', handleStepAnswerInput);
        textarea.focus();
      }

      // Show/hide experiment components for Steps 6-9
      const expComponents = document.getElementById('experiment-components');
      const ps101Input = document.getElementById('ps101-input');

      if ([6, 7, 8, 9].includes(state.currentStep) && promptIndex === totalPrompts - 1) {
        // Show experiment component for this step, hide regular input
        if (expComponents) {
          expComponents.classList.remove('hidden');
          // Ensure active experiment exists
          let activeExp = PS101State.getActiveExperiment();
          if (!activeExp && state.currentStep === 6) {
            activeExp = PS101State.createExperiment();
          }

          // Show relevant component
          if (state.currentStep === 6) {
            renderExperimentCanvas(activeExp);
          } else if (state.currentStep === 7) {
            renderObstacleMapping(activeExp);
          } else if (state.currentStep === 8) {
            renderActionPlan(activeExp);
          } else if (state.currentStep === 9) {
            renderReflectionLog(activeExp);
          }
        }
        if (ps101Input) ps101Input.classList.add('hidden');
      } else {
        // Hide experiment components, show regular input
        if (expComponents) expComponents.classList.add('hidden');
        if (ps101Input) ps101Input.classList.remove('hidden');
      }

      // Update navigation buttons
      updateNavButtons(state.currentStep, promptIndex, totalPrompts);

      // Update previous answers
      renderPreviousAnswers(state.currentStep);
    }

    // Experiment Component Rendering Functions
    function renderExperimentCanvas(experiment) {
      if (!experiment) return;

      const canvas = document.getElementById('experiment-canvas');
      const obstacleMapping = document.getElementById('obstacle-mapping');
      const actionPlan = document.getElementById('action-plan');
      const reflectionLog = document.getElementById('reflection-log');

      // Show canvas, hide others
      if (canvas) canvas.classList.remove('hidden');
      if (obstacleMapping) obstacleMapping.classList.add('hidden');
      if (actionPlan) actionPlan.classList.add('hidden');
      if (reflectionLog) reflectionLog.classList.add('hidden');

      // Populate fields
      const hypothesis = document.getElementById('exp-hypothesis');
      const successMetric = document.getElementById('exp-success-metric');
      const startDate = document.getElementById('exp-start-date');
      const reviewDate = document.getElementById('exp-review-date');
      const resources = document.getElementById('exp-resources');

      if (hypothesis) hypothesis.value = experiment.hypothesis || '';
      if (successMetric) successMetric.value = experiment.successMetric || '';
      if (startDate) startDate.value = experiment.duration?.start || '';
      if (reviewDate) reviewDate.value = experiment.duration?.review || '';
      if (resources) resources.value = experiment.resources || '';
    }

    // Render welcome screen
    function renderWelcomeScreen() {
      const state = PS101State;
      const welcome = document.getElementById('ps101-welcome');
      const flow = document.getElementById('ps101-flow');
      const completion = document.getElementById('ps101-completion');

      if (welcome) welcome.classList.remove('hidden');
      if (flow) flow.classList.add('hidden');
      if (completion) completion.classList.add('hidden');

      // Check if user has progress
      const hasProgress = state.steps && Object.keys(state.steps).length > 0;
      const resumeSection = document.getElementById('welcome-resume');

      if (resumeSection) {
        if (hasProgress && !state.completed) {
          resumeSection.classList.remove('hidden');
        } else {
          resumeSection.classList.add('hidden');
        }
      }
    }

    // Render completion screen
    function renderCompletionScreen() {
      const state = PS101State;
      const completion = document.getElementById('ps101-completion');
      const flow = document.getElementById('ps101-flow');
      const welcome = document.getElementById('ps101-welcome');

      if (completion) completion.classList.remove('hidden');
      if (flow) flow.classList.add('hidden');
      if (welcome) welcome.classList.add('hidden');

      // Render commitment highlight
      const commitmentText = document.getElementById('commitment-text');
      if (commitmentText) {
        commitmentText.textContent = state.getAnswer(7);
      }

      // Render all answers
      const completionAnswers = document.getElementById('completion-answers');
      if (completionAnswers) {
        completionAnswers.innerHTML = '';
        PS101_STEPS.forEach(step => {
          const answer = state.getAnswer(step.number);
          const card = document.createElement('div');
          card.className = 'answer-card';
          card.innerHTML = `
            <div class="answer-header">
              <span class="answer-step">Step ${step.number}: ${step.title}</span>
            </div>
            <div class="answer-content">${escapeHtml(answer)}</div>
          `;
          completionAnswers.appendChild(card);
        });
      }
    }

    // Event listeners setup - now handled by consolidated initApp() via initPS101EventListeners()
    // Removed duplicate DOMContentLoaded handler - all logic consolidated into initPS101EventListeners()

    // Add link to PS101 module to start flow
    const ps101Module = document.getElementById('ps101');
    if (ps101Module) {
      const moduleLink = ps101Module.querySelector('a');
      if (moduleLink) {
        moduleLink.addEventListener('click', (e) => {
          e.preventDefault();
          // Check if user has progress
          if (PS101State.steps && Object.keys(PS101State.steps).length > 0 && !PS101State.completed) {
            renderCurrentStep();
            document.getElementById('ps101-flow')?.scrollIntoView({ behavior: 'smooth' });
          } else {
            renderWelcomeScreen();
            document.getElementById('ps101-welcome')?.scrollIntoView({ behavior: 'smooth' });
          }
        });
      }

      // Also link the "start here" action in the module
      const startHereLink = ps101Module.querySelector('[data-prompt]');
      if (startHereLink) {
        startHereLink.addEventListener('click', (e) => {
          // Don't prevent default - let it also trigger chat
          // But also show PS101 flow if user wants
          setTimeout(() => {
            if (PS101State.steps && Object.keys(PS101State.steps).length > 0 && !PS101State.completed) {
              renderCurrentStep();
              document.getElementById('ps101-flow')?.scrollIntoView({ behavior: 'smooth' });
            } else {
              renderWelcomeScreen();
              document.getElementById('ps101-welcome')?.scrollIntoView({ behavior: 'smooth' });
            }
          }, 500);
        });
      }
    }

})();

</script>
<!-- BUILD_ID:5cf9088cd271e2ae767620496b2d3802aa10eb2a|SHA:7795ae25 -->
